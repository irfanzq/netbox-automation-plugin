{% extends 'base/layout.html' %}
{% load i18n %}
{% load render_table from django_tables2 %}
{% load form_helpers %}

{% block title %}{% trans "VLAN Deployment Results" %}{% endblock %}

{% block content %}
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">{% trans "VLAN Deployment Summary" %}</h5>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-md-3">{% trans "Devices" %}</dt>
            <dd class="col-md-3">{{ summary.device_count }}</dd>

            <dt class="col-md-3">{% trans "Interfaces" %}</dt>
            <dd class="col-md-3">{{ summary.interface_count }}</dd>

            <dt class="col-md-3 text-success">{% trans "Successful" %}</dt>
            <dd class="col-md-3 text-success">{{ summary.success }}</dd>

            <dt class="col-md-3 text-info">{% trans "Dry Run" %}</dt>
            <dd class="col-md-3 text-info">{{ summary.dry_run }}</dd>

            <dt class="col-md-3 text-danger">{% trans "Errors" %}</dt>
            <dd class="col-md-3 text-danger">{{ summary.error }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">{% trans "VLAN Deployment Results" %}</h5>
          <div>
            <div class="btn-group btn-group-sm me-2" role="group" id="status-filter-buttons">
              <button type="button" class="btn btn-primary active" data-filter="all">All</button>
              <button type="button" class="btn btn-outline-primary" data-filter="blocked">Blocked Only</button>
              <button type="button" class="btn btn-outline-primary" data-filter="warnings">Warnings Only</button>
            </div>
            <button type="button" id="download-csv-btn" class="btn btn-sm btn-secondary">
              <i class="mdi mdi-download"></i>
              {% trans "Download CSV" %}
            </button>
          </div>
        </div>
        <div class="card-body table-responsive">
          {% render_table table %}
        </div>
      </div>
      
      <script>
        // Status filter functionality
        document.addEventListener('DOMContentLoaded', function() {
          const filterButtons = document.querySelectorAll('#status-filter-buttons button');
          const tableRows = document.querySelectorAll('tbody tr');
          
          filterButtons.forEach(button => {
            button.addEventListener('click', function() {
              // Update button states
              filterButtons.forEach(btn => {
                btn.classList.remove('active', 'btn-primary');
                btn.classList.add('btn-outline-primary');
              });
              this.classList.add('active', 'btn-primary');
              this.classList.remove('btn-outline-primary');
              
              // Get filter value
              const filter = this.getAttribute('data-filter');
              
              // Filter rows
              let visibleCount = 0;
              tableRows.forEach(row => {
                const details = row.querySelector('details.deployment-logs');
                const statusFilter = details ? details.getAttribute('data-status-filter') : '';
                
                // Find Overall Status column - it's the 6th column (after Device, Interface, VLAN, Device Status, Interface Status)
                const cells = row.querySelectorAll('td');
                let statusText = '';
                
                // Try to find status from data attribute first
                if (statusFilter) {
                  statusText = statusFilter;
                } else {
                  // Fallback: look for badge in cells (Overall Status should be around index 5)
                  if (cells.length > 5) {
                    const statusCell = cells[5];
                    const badge = statusCell.querySelector('.badge');
                    if (badge) {
                      const text = badge.textContent.trim().toLowerCase();
                      if (text === 'pass' || text === 'warn' || text === 'blocked') {
                        statusText = text;
                      }
                    }
                  }
                }
                
                let show = false;
                if (filter === 'all') {
                  show = true;
                } else if (filter === 'blocked') {
                  show = statusText === 'blocked';
                } else if (filter === 'warnings') {
                  show = statusText === 'warn';
                }
                
                if (show) {
                  row.style.display = '';
                  visibleCount++;
                } else {
                  row.style.display = 'none';
                }
              });
              
              // Update summary if needed
              console.log(`Showing ${visibleCount} of ${tableRows.length} rows`);
            });
          });
        });
        
        // CSV download functionality
        document.getElementById('download-csv-btn').addEventListener('click', function() {
          // Get the table
          const table = document.querySelector('table');
          let csv = [];
          
          // Get headers
          const headers = [];
          table.querySelectorAll('thead th').forEach(th => {
            headers.push(th.textContent.trim());
          });
          csv.push(headers.join(','));
          
          // Get rows (only visible ones)
          table.querySelectorAll('tbody tr').forEach(tr => {
            if (tr.style.display !== 'none') {
              const row = [];
              tr.querySelectorAll('td').forEach(td => {
                // Escape quotes and wrap in quotes if contains comma
                let value = td.textContent.trim().replace(/"/g, '""');
                if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                  value = '"' + value + '"';
                }
                row.push(value);
              });
              csv.push(row.join(','));
            }
          });
          
          // Create download
          const csvContent = csv.join('\n');
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'vlan_deployment_results.csv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        });
      </script>
    </div>
  </div>
{% endblock %}

