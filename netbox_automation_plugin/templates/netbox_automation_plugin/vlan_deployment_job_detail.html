{% extends 'base/layout.html' %}
{% load i18n %}

{% block title %}{% trans "VLAN Deployment Job" %} #{{ job.id }}{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          {% trans "VLAN Deployment Job" %} #{{ job.id }}
          <span class="badge {% if job.job_type == 'dryrun' %}bg-info{% else %}bg-primary{% endif %} ms-2">
            {{ job.get_job_type_display }}
          </span>
          <span class="badge {% if job.status == 'completed' %}bg-success{% elif job.status == 'failed' %}bg-danger{% elif job.status == 'running' %}bg-warning text-dark{% else %}bg-secondary{% endif %} ms-2">
            {{ job.get_status_display }}
          </span>
        </h5>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <h6>{% trans "Job Information" %}</h6>
            <table class="table table-sm">
              <tbody>
                <tr>
                  <th>{% trans "ID" %}</th>
                  <td>{{ job.id }}</td>
                </tr>
                <tr>
                  <th>{% trans "Type" %}</th>
                  <td>
                    <span class="badge {% if job.job_type == 'dryrun' %}bg-info{% else %}bg-primary{% endif %}">
                      {{ job.get_job_type_display }}
                    </span>
                  </td>
                </tr>
                <tr>
                  <th>{% trans "Status" %}</th>
                  <td>
                    <span class="badge {% if job.status == 'completed' %}bg-success{% elif job.status == 'failed' %}bg-danger{% elif job.status == 'running' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                      {{ job.get_status_display }}
                    </span>
                  </td>
                </tr>
                <tr>
                  <th>{% trans "Created By" %}</th>
                  <td>{{ job.created_by|default:"N/A" }}</td>
                </tr>
                <tr>
                  <th>{% trans "Created" %}</th>
                  <td>{{ job.created|date:"Y-m-d H:i:s" }}</td>
                </tr>
                <tr>
                  <th>{% trans "Started" %}</th>
                  <td>{{ job.started_at|date:"Y-m-d H:i:s"|default:"—" }}</td>
                </tr>
                <tr>
                  <th>{% trans "Completed" %}</th>
                  <td>{{ job.completed_at|date:"Y-m-d H:i:s"|default:"—" }}</td>
                </tr>
                {% if job.started_at and job.completed_at %}
                <tr>
                  <th>{% trans "Duration" %}</th>
                  <td>{{ job.completed_at|timesince:job.started_at }}</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
          <div class="col-md-6">
            <h6>{% trans "Deployment Parameters" %}</h6>
            <table class="table table-sm">
              <tbody>
                <tr>
                  <th>{% trans "Deployment Scope" %}</th>
                  <td>{{ job.get_deployment_scope_display }}</td>
                </tr>
                <tr>
                  <th>{% trans "Sync Mode" %}</th>
                  <td>
                    {% if job.sync_netbox_to_device %}
                      <span class="badge bg-info">{% trans "Enabled" %}</span>
                    {% else %}
                      <span class="badge bg-secondary">{% trans "Disabled" %}</span>
                    {% endif %}
                  </td>
                </tr>
                {% if job.untagged_vlan_id %}
                <tr>
                  <th>{% trans "Untagged VLAN" %}</th>
                  <td>VLAN {{ job.untagged_vlan_id }}</td>
                </tr>
                {% endif %}
                <tr>
                  <th>{% trans "Tagged VLANs" %}</th>
                  <td>
                    {% if job.tagged_vlan_ids and job.tagged_vlan_ids|length > 0 %}
                      {% for vlan_id in job.tagged_vlan_ids %}
                        <span class="badge bg-secondary">VLAN {{ vlan_id }}</span>
                      {% endfor %}
                    {% else %}
                      <span class="text-muted">{% trans "None" %}</span>
                    {% endif %}
                  </td>
                </tr>
                <tr>
                  <th>{% trans "Devices" %}</th>
                  <td>
                    {% if devices %}
                      <ul class="mb-0">
                        {% for device in devices %}
                          <li><a href="{{ device.get_absolute_url }}">{{ device.name }}</a></li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      <span class="text-muted">{% trans "No devices" %}</span>
                    {% endif %}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        {% if job.error_message %}
        <div class="alert alert-danger">
          <h6>{% trans "Error Message" %}</h6>
          <pre class="mb-0">{{ job.error_message }}</pre>
        </div>
        {% endif %}

        {% if result_summary %}
        <div class="row mb-3">
          <div class="col-md-12">
            <h6>{% trans "Results Summary" %}</h6>
            {% if result_summary.summary %}
            <div class="card">
              <div class="card-body">
                <pre style="white-space: pre-wrap;">{{ result_summary.summary|safe }}</pre>
              </div>
            </div>
            {% endif %}
            {% if result_summary.status_counts %}
            <div class="card mt-2">
              <div class="card-body">
                <h6>{% trans "Status Counts" %}</h6>
                <pre style="white-space: pre-wrap;">{{ result_summary.status_counts|safe }}</pre>
              </div>
            </div>
            {% endif %}
            {% if result_summary.device_count %}
            <div class="card mt-2">
              <div class="card-body">
                <p><strong>{% trans "Total Devices" %}:</strong> {{ result_summary.device_count }}</p>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}

        {% if execution_log %}
        <div class="row mb-3">
          <div class="col-md-12">
            <h6>{% trans "Execution Log" %}</h6>
            <div class="card">
              <div class="card-body">
                <pre style="max-height: 500px; overflow-y: auto; white-space: pre-wrap; font-family: monospace; font-size: 12px;">{{ execution_log }}</pre>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <div class="mt-3">
          <a href="{% url 'plugins:netbox_automation_plugin:vlan_deployment_jobs' %}" class="btn btn-secondary">
            <i class="mdi mdi-arrow-left"></i> {% trans "Back to Jobs" %}
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
