{% extends 'base/layout.html' %}
{% load i18n %}
{% load render_table from django_tables2 %}
{% load form_helpers %}

{% block title %}{% trans "VLAN Deployment Results" %}{% endblock %}

{% block content %}
<style>
  /* MINIMAL FIX: Only table headers and device names in dark mode - nothing else */
  
  /* Table headers - White ONLY in dark mode */
  html[data-theme="dark"] table th,
  html[data-theme="dark"] table th *,
  html[data-theme="dark"] table th.orderable,
  html[data-theme="dark"] table th.orderable *,
  html[data-theme="dark"] table th.orderable a,
  html[data-theme="dark"] table th a,
  html[data-theme="dark"] table th span,
  html[data-theme="dark"] table th strong,
  html[data-theme="dark"] table thead th,
  html[data-theme="dark"] table thead th *,
  html[data-theme="dark"] table thead th a,
  html[data-theme="dark"] table thead th span,
  html[data-theme="dark"] table thead th strong,
  html[data-theme="dark"] table thead tr th,
  html[data-theme="dark"] table thead tr th *,
  html[data-theme="dark"] table thead tr th a,
  html[data-theme="dark"] table thead tr th span,
  html[data-theme="dark"] table thead tr th strong,
  body.dark-mode table th,
  body.dark-mode table th *,
  body.dark-mode table th.orderable,
  body.dark-mode table th.orderable *,
  body.dark-mode table th.orderable a,
  body.dark-mode table th a,
  body.dark-mode table th span,
  body.dark-mode table th strong,
  body.dark-mode table thead th,
  body.dark-mode table thead th *,
  body.dark-mode table thead th a,
  body.dark-mode table thead th span,
  body.dark-mode table thead th strong,
  body.dark-mode table thead tr th,
  body.dark-mode table thead tr th *,
  body.dark-mode table thead tr th a,
  body.dark-mode table thead tr th span,
  body.dark-mode table thead tr th strong,
  body[data-bs-theme="dark"] table th,
  body[data-bs-theme="dark"] table th *,
  body[data-bs-theme="dark"] table th.orderable,
  body[data-bs-theme="dark"] table th.orderable *,
  body[data-bs-theme="dark"] table th.orderable a,
  body[data-bs-theme="dark"] table th a,
  body[data-bs-theme="dark"] table th span,
  body[data-bs-theme="dark"] table th strong,
  body[data-bs-theme="dark"] table thead th,
  body[data-bs-theme="dark"] table thead th *,
  body[data-bs-theme="dark"] table thead th a,
  body[data-bs-theme="dark"] table thead th span,
  body[data-bs-theme="dark"] table thead th strong,
  body[data-bs-theme="dark"] table thead tr th,
  body[data-bs-theme="dark"] table thead tr th *,
  body[data-bs-theme="dark"] table thead tr th a,
  body[data-bs-theme="dark"] table thead tr th span,
  body[data-bs-theme="dark"] table thead tr th strong {
    color: #ffffff !important;
  }
  
  /* Device names in table (first column) - Teal in light mode, white in dark mode */
  .table tbody td:first-child,
  .table tbody td:first-child a,
  .table tbody td:first-child span,
  .table tbody td:first-child strong {
    color: #20c997 !important; /* Teal for light mode */
  }
  
  html[data-theme="dark"] .table tbody td:first-child,
  html[data-theme="dark"] .table tbody td:first-child a,
  html[data-theme="dark"] .table tbody td:first-child span,
  html[data-theme="dark"] .table tbody td:first-child strong,
  body.dark-mode .table tbody td:first-child,
  body.dark-mode .table tbody td:first-child a,
  body.dark-mode .table tbody td:first-child span,
  body.dark-mode .table tbody td:first-child strong,
  body[data-bs-theme="dark"] .table tbody td:first-child,
  body[data-bs-theme="dark"] .table tbody td:first-child a,
  body[data-bs-theme="dark"] .table tbody td:first-child span,
  body[data-bs-theme="dark"] .table tbody td:first-child strong {
    color: #ffffff !important; /* White for dark mode */
  }
  
  /* Device names in summary cards - Teal in light mode, vibrant teal/cyan in dark mode */
  .device-summary-card h6,
  .device-summary-card h6 a,
  .device-summary-card h6 span,
  .device-summary-card h6 strong {
    color: #20c997 !important; /* Teal for light mode */
  }
  
  html[data-theme="dark"] .device-summary-card h6,
  html[data-theme="dark"] .device-summary-card h6 a,
  html[data-theme="dark"] .device-summary-card h6 span,
  html[data-theme="dark"] .device-summary-card h6 strong,
  body.dark-mode .device-summary-card h6,
  body.dark-mode .device-summary-card h6 a,
  body.dark-mode .device-summary-card h6 span,
  body.dark-mode .device-summary-card h6 strong,
  body[data-bs-theme="dark"] .device-summary-card h6,
  body[data-bs-theme="dark"] .device-summary-card h6 a,
  body[data-bs-theme="dark"] .device-summary-card h6 span,
  body[data-bs-theme="dark"] .device-summary-card h6 strong {
    color: #4dd4ac !important; /* Vibrant teal/cyan for dark mode */
  }
  
  /* Colored text - brighter in dark mode */
  .text-success { color: #198754 !important; }
  html[data-theme="dark"] .text-success, body.dark-mode .text-success { color: #75d175 !important; }
  
  .text-info { color: #0dcaf0 !important; }
  html[data-theme="dark"] .text-info, body.dark-mode .text-info { color: #6ec9f0 !important; }
  
  .text-danger { color: #dc3545 !important; }
  html[data-theme="dark"] .text-danger, body.dark-mode .text-danger { color: #ff6b7a !important; }
  
  .text-warning { color: #856404 !important; }
  html[data-theme="dark"] .text-warning, body.dark-mode .text-warning { color: #ffd966 !important; }
  
  /* Badges */
  .badge { color: #ffffff !important; }
  .badge.bg-warning { color: #000000 !important; }
  
  /* Filter buttons - proper visibility with filled dot when active */
  .btn-outline-primary {
    color: #0d6efd !important;
    border-color: #0d6efd !important;
    background-color: transparent !important;
  }
  
  html[data-theme="dark"] .btn-outline-primary,
  body.dark-mode .btn-outline-primary {
    color: #4da6ff !important;
    border-color: #4da6ff !important;
  }
  
  .btn-outline-primary.active,
  .btn-primary.active,
  .btn-primary {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: #ffffff !important;
  }
  
  /* Bulk action buttons (Expand All / Collapse All) - Light grey background with dark text */
  #bulk-action-buttons .btn {
    color: var(--nbx-color-fg-default, #212529) !important; /* Dark text for readability */
    background-color: var(--nbx-color-bg-secondary, #e9ecef) !important; /* Light grey background */
    border-color: var(--nbx-color-border-default, #ced4da) !important;
  }

  /* In dark mode, keep light grey background but use dark text for contrast */
  html[data-theme="dark"] #bulk-action-buttons .btn,
  body.dark-mode #bulk-action-buttons .btn {
    color: var(--nbx-color-fg-default, #212529) !important; /* Dark text on light grey background */
    background-color: var(--nbx-color-bg-secondary, #e9ecef) !important; /* Light grey background */
    border-color: var(--nbx-color-border-default, #ced4da) !important;
  }
  
  /* Ensure icons inside buttons also have dark text */
  #bulk-action-buttons .btn i {
    color: var(--nbx-color-fg-default, #212529) !important;
  }
  
  html[data-theme="dark"] #bulk-action-buttons .btn i,
  body.dark-mode #bulk-action-buttons .btn i {
    color: var(--nbx-color-fg-default, #212529) !important; /* Dark icon on light grey background */
  }
  
  /* Section headers - Vibrant blue that works in both light and dark modes */
  .card-header h5.card-title,
  .card-header .card-title {
    color: #0066cc !important; /* Vibrant blue for light mode */
  }
  
  html[data-theme="dark"] .card-header h5.card-title,
  html[data-theme="dark"] .card-header .card-title,
  body.dark-mode .card-header h5.card-title,
  body.dark-mode .card-header .card-title,
  body[data-bs-theme="dark"] .card-header h5.card-title,
  body[data-bs-theme="dark"] .card-header .card-title {
    color: #4da6ff !important; /* Brighter blue for dark mode */
  }
  
  /* VLAN Deployment Summary labels and values - Vibrant blue */
  .card-body dl.row .summary-label,
  .card-body dl.row .summary-value {
    color: #0066cc !important; /* Vibrant blue for light mode */
  }
  
  html[data-theme="dark"] .card-body dl.row .summary-label,
  html[data-theme="dark"] .card-body dl.row .summary-value,
  body.dark-mode .card-body dl.row .summary-label,
  body.dark-mode .card-body dl.row .summary-value,
  body[data-bs-theme="dark"] .card-body dl.row .summary-label,
  body[data-bs-theme="dark"] .card-body dl.row .summary-value {
    color: #4da6ff !important; /* Brighter blue for dark mode */
  }
  
  /* Interface and VLAN column values - Teal/cyan color matching device names */
  .table tbody td:nth-child(2),
  .table tbody td:nth-child(3),
  .table tbody td:nth-child(2) a,
  .table tbody td:nth-child(3) a,
  .table tbody td:nth-child(2) span,
  .table tbody td:nth-child(3) span,
  .table tbody td:nth-child(2) strong,
  .table tbody td:nth-child(3) strong {
    color: #20c997 !important; /* Teal for light mode */
  }
  
  html[data-theme="dark"] .table tbody td:nth-child(2),
  html[data-theme="dark"] .table tbody td:nth-child(3),
  html[data-theme="dark"] .table tbody td:nth-child(2) a,
  html[data-theme="dark"] .table tbody td:nth-child(3) a,
  html[data-theme="dark"] .table tbody td:nth-child(2) span,
  html[data-theme="dark"] .table tbody td:nth-child(3) span,
  html[data-theme="dark"] .table tbody td:nth-child(2) strong,
  html[data-theme="dark"] .table tbody td:nth-child(3) strong,
  body.dark-mode .table tbody td:nth-child(2),
  body.dark-mode .table tbody td:nth-child(3),
  body.dark-mode .table tbody td:nth-child(2) a,
  body.dark-mode .table tbody td:nth-child(3) a,
  body.dark-mode .table tbody td:nth-child(2) span,
  body.dark-mode .table tbody td:nth-child(3) span,
  body.dark-mode .table tbody td:nth-child(2) strong,
  body.dark-mode .table tbody td:nth-child(3) strong,
  body[data-bs-theme="dark"] .table tbody td:nth-child(2),
  body[data-bs-theme="dark"] .table tbody td:nth-child(3),
  body[data-bs-theme="dark"] .table tbody td:nth-child(2) a,
  body[data-bs-theme="dark"] .table tbody td:nth-child(3) a,
  body[data-bs-theme="dark"] .table tbody td:nth-child(2) span,
  body[data-bs-theme="dark"] .table tbody td:nth-child(3) span,
  body[data-bs-theme="dark"] .table tbody td:nth-child(2) strong,
  body[data-bs-theme="dark"] .table tbody td:nth-child(3) strong {
    color: #4dd4ac !important; /* Brighter teal for dark mode */
  }
</style>
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">{% trans "VLAN Deployment Summary" %}</h5>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-md-3 summary-label">{% trans "Devices" %}</dt>
            <dd class="col-md-3 summary-value">{{ summary.device_count }}</dd>

            <dt class="col-md-3 summary-label">{% trans "Interfaces" %}</dt>
            <dd class="col-md-3 summary-value">{{ summary.interface_count }}</dd>

            <dt class="col-md-3 text-success">{% trans "Successful" %}</dt>
            <dd class="col-md-3 text-success">{{ summary.success }}</dd>

            <dt class="col-md-3 text-info">{% trans "Dry Run" %}</dt>
            <dd class="col-md-3 text-info">{{ summary.dry_run }}</dd>

            <dt class="col-md-3 text-danger">{% trans "Errors" %}</dt>
            <dd class="col-md-3 text-danger">{{ summary.error }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  {# Device Summary Cards #}
  {% if device_summaries %}
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">{% trans "Device Summary" %}</h5>
        </div>
        <div class="card-body">
          <div class="row">
            {% for device_summary in device_summaries %}
            <div class="col-md-3 mb-2">
              <div class="card device-summary-card" 
                   data-device-name="{{ device_summary.device_name }}"
                   style="cursor: pointer; border-left: 4px solid {% if device_summary.device_status == 'pass' %}#198754{% elif device_summary.device_status == 'warn' %}#ffc107{% else %}#dc3545{% endif %};">
                <div class="card-body p-2">
                  <h6 class="mb-1">
                    {% if device_summary.device and device_summary.device.pk %}
                      <a href="{% url 'dcim:device' pk=device_summary.device.pk %}" onclick="event.stopPropagation();">{{ device_summary.device_name }}</a>
                    {% else %}
                      <span>{{ device_summary.device_name }}</span>
                    {% endif %}
                  </h6>
                  <div class="small">
                    <span class="badge bg-secondary">{{ device_summary.total }} total</span>
                    <span class="badge bg-success">{{ device_summary.pass }} pass</span>
                    {% if device_summary.warn > 0 %}
                    <span class="badge bg-warning text-dark">{{ device_summary.warn }} warn</span>
                    {% endif %}
                    {% if device_summary.blocked > 0 %}
                    <span class="badge bg-danger">{{ device_summary.blocked }} blocked</span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">{% trans "VLAN Deployment Results" %}</h5>
          <div>
            <div class="btn-group btn-group-sm me-2" role="group" id="status-filter-buttons">
              <button type="button" class="btn btn-primary active" data-filter="all">
                All{% if status_counts.total %} ({{ status_counts.total }}){% endif %}
              </button>
              <button type="button" class="btn btn-outline-primary" data-filter="pass">
                Pass Only{% if status_counts.pass %} ({{ status_counts.pass }}){% endif %}
              </button>
              <button type="button" class="btn btn-outline-primary" data-filter="warnings">
                Warnings Only{% if status_counts.warn %} ({{ status_counts.warn }}){% endif %}
              </button>
              <button type="button" class="btn btn-outline-primary" data-filter="blocked">
                Blocked Only{% if status_counts.blocked %} ({{ status_counts.blocked }}){% endif %}
              </button>
            </div>
            <div class="btn-group btn-group-sm me-2" role="group" id="bulk-action-buttons">
              <button type="button" class="btn" id="expand-all-btn" title="Expand all deployment log details">
                <i class="mdi mdi-unfold-more-horizontal"></i> Expand All
              </button>
              <button type="button" class="btn" id="collapse-all-btn" title="Collapse all deployment log details">
                <i class="mdi mdi-unfold-less-horizontal"></i> Collapse All
              </button>
            </div>
            <button type="button" id="download-csv-btn" class="btn btn-sm btn-secondary">
              <i class="mdi mdi-download"></i>
              {% trans "Download CSV" %}
            </button>
          </div>
        </div>
        <div class="card-body table-responsive">
          {% render_table table %}
        </div>
      </div>
      
      <script>
        // NetBox Theme Detection and Color Application
        function getNetBoxTheme() {
          try {
            return localStorage.getItem('netbox-color-mode') || 'light';
          } catch (e) {
            // Fallback: check if NetBox has set data-theme attribute
            const htmlEl = document.documentElement;
            if (htmlEl && htmlEl.getAttribute('data-theme') === 'dark') {
              return 'dark';
            }
            if (document.body && document.body.classList.contains('dark-mode')) {
              return 'dark';
            }
            return 'light';
          }
        }
        
        function isDarkMode() {
          return getNetBoxTheme() === 'dark';
        }
        
        function applyThemeColors() {
          const darkMode = isDarkMode();
          const textColor = darkMode ? '#ffffff' : '#212529';
          const bgColor = darkMode ? '#2a2a2a' : '#f5f5f5';

          // Apply to all text elements in card-body (excluding badges and colored text classes)
          document.querySelectorAll('.card-body p, .card-body label, .card-body span:not(.badge), .card-body small, .card-body div:not(.badge), .card-body .form-text, .card-body .text-muted, .card-body h1, .card-body h2, .card-body h3, .card-body h4, .card-body h5, .card-body h6, .card-body dt, .card-body dd').forEach(el => {
            // Skip badges and colored text classes (they have their own styling)
            if (!el.classList.contains('badge') && 
                !el.classList.contains('text-success') && 
                !el.classList.contains('text-info') && 
                !el.classList.contains('text-danger') && 
                !el.classList.contains('text-warning')) {
              el.style.setProperty('color', textColor, 'important');
              if (el.classList.contains('text-muted') || el.classList.contains('form-text')) {
                el.style.setProperty('opacity', '1', 'important');
              }
            }
          });

          // Apply to card header
          document.querySelectorAll('.card-header, .card-header h5, .card-header .card-title').forEach(el => {
            el.style.setProperty('color', textColor, 'important');
          });

          // Apply to deployment logs - ALL text inside
          document.querySelectorAll('.deployment-logs div').forEach(el => {
            el.style.setProperty('background-color', bgColor, 'important');
            el.style.setProperty('color', textColor, 'important');
          });

          // Apply to ALL text inside deployment logs
          document.querySelectorAll('.deployment-logs div *').forEach(el => {
            el.style.setProperty('color', textColor, 'important');
          });

          // Apply to code/pre blocks
          document.querySelectorAll('.deployment-logs div pre, .deployment-logs div code').forEach(el => {
            el.style.setProperty('background-color', darkMode ? '#1a1a1a' : '#e9ecef', 'important');
            el.style.setProperty('color', textColor, 'important');
          });

          // Apply to table text
          document.querySelectorAll('.table td, .table th').forEach(el => {
            el.style.setProperty('color', textColor, 'important');
          });

          // Apply to summary section (dt/dd) - preserve color classes in both modes
          document.querySelectorAll('dt, dd').forEach(el => {
            // Apply appropriate colors based on color classes in both light and dark mode
            if (el.classList.contains('text-success')) {
              el.style.setProperty('color', darkMode ? '#75d175' : '#198754', 'important');
            } else if (el.classList.contains('text-info')) {
              el.style.setProperty('color', darkMode ? '#6ec9f0' : '#0dcaf0', 'important');
            } else if (el.classList.contains('text-danger')) {
              el.style.setProperty('color', darkMode ? '#ff6b7a' : '#dc3545', 'important');
            } else if (el.classList.contains('text-warning')) {
              el.style.setProperty('color', darkMode ? '#ffd966' : '#856404', 'important');
            } else {
              // No color class - use default text color
              el.style.setProperty('color', textColor, 'important');
            }
          });

          // Apply to buttons (but exclude bulk action buttons which have their own styling)
          document.querySelectorAll('.btn:not(.btn-primary):not(.btn-secondary):not(#bulk-action-buttons .btn)').forEach(el => {
            // Skip bulk action buttons - they have light grey background with dark text in both modes
            if (el.closest('#bulk-action-buttons')) {
              return;
            }
            if (!el.classList.contains('btn-outline-primary') && !el.classList.contains('btn-outline-secondary')) {
              el.style.setProperty('color', textColor, 'important');
            }
          });
          
          // Ensure bulk action buttons always have dark text on light grey background
          document.querySelectorAll('#bulk-action-buttons .btn').forEach(el => {
            el.style.setProperty('color', '#212529', 'important'); // Dark text
            el.style.setProperty('background-color', '#e9ecef', 'important'); // Light grey background
            el.style.setProperty('border-color', '#ced4da', 'important');
          });
          
          // Ensure icons in bulk action buttons also have dark text
          document.querySelectorAll('#bulk-action-buttons .btn i').forEach(el => {
            el.style.setProperty('color', '#212529', 'important'); // Dark icon
          });

          // Apply to badges (keep their specific colors but ensure text is visible)
          document.querySelectorAll('.badge').forEach(el => {
            if (el.classList.contains('bg-warning')) {
              el.style.setProperty('color', '#000000', 'important'); // Black text on yellow
            } else {
              el.style.setProperty('color', '#ffffff', 'important'); // White text on colored badges
            }
          });

          // Apply to form text elements globally
          document.querySelectorAll('.form-text, .text-muted, small').forEach(el => {
            if (!el.classList.contains('badge')) {
              el.style.setProperty('color', textColor, 'important');
              el.style.setProperty('opacity', '1', 'important');
            }
          });
        }
        
        // MINIMAL FIX: Only table headers and device names in dark mode
        function forceWhiteText() {
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark' || 
                        document.body.classList.contains('dark-mode') ||
                        document.documentElement.getAttribute('data-bs-theme') === 'dark';
          if (!isDark) return; // Only run in dark mode
          
          // Table headers ONLY - force white
          document.querySelectorAll('table th, table thead th, table thead tr th, table th.orderable, table th.orderable a, table th a').forEach(el => {
            el.style.setProperty('color', '#ffffff', 'important');
            // Force on direct children
            el.querySelectorAll('*').forEach(child => {
              if (!child.closest('.badge') && !child.closest('.btn')) {
                child.style.setProperty('color', '#ffffff', 'important');
              }
            });
          });
          
          // Device names in first column ONLY - force white
          document.querySelectorAll('table tbody td:first-child, table tbody td:first-child a, table tbody td:first-child span, table tbody td:first-child strong').forEach(el => {
            if (!el.closest('.badge') && !el.closest('.btn')) {
              el.style.setProperty('color', '#ffffff', 'important');
              // Force on direct children only
              el.querySelectorAll('*').forEach(child => {
                if (!child.closest('.badge') && !child.closest('.btn')) {
                  child.style.setProperty('color', '#ffffff', 'important');
                }
              });
            }
          });
          
          // Device names in summary cards - teal in light mode, vibrant teal/cyan in dark mode
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark' || 
                        document.body.classList.contains('dark-mode') ||
                        document.documentElement.getAttribute('data-bs-theme') === 'dark';
          document.querySelectorAll('.device-summary-card h6, .device-summary-card h6 a, .device-summary-card h6 span, .device-summary-card h6 strong').forEach(el => {
            if (!el.closest('.badge') && !el.closest('.btn')) {
              if (isDark) {
                el.style.setProperty('color', '#4dd4ac', 'important'); // Vibrant teal/cyan for dark mode
              } else {
                el.style.setProperty('color', '#20c997', 'important'); // Teal for light mode
              }
            }
          });
        }
        
        // Apply on page load - AGGRESSIVE approach
        document.addEventListener('DOMContentLoaded', function() {
          applyThemeColors();
          forceWhiteText();
          
          // Reapply multiple times to catch NetBox's dynamic style application
          setTimeout(forceWhiteText, 50);
          setTimeout(forceWhiteText, 100);
          setTimeout(forceWhiteText, 300);
          setTimeout(forceWhiteText, 500);
          setTimeout(forceWhiteText, 1000);
          setTimeout(forceWhiteText, 2000);
          
          // Listen for theme changes
          window.addEventListener('netbox.colorModeChanged', function() {
            setTimeout(forceWhiteText, 50);
            setTimeout(forceWhiteText, 200);
          });
          
          // More aggressive periodic check - every 1 second
          setInterval(forceWhiteText, 1000);
          
          // MutationObserver to catch any dynamically added elements
          const observer = new MutationObserver(function(mutations) {
            forceWhiteText();
          });
          observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['style', 'class', 'data-theme', 'data-bs-theme']
          });
        });
      </script>

      <script>
        // Status filter functionality
        document.addEventListener('DOMContentLoaded', function() {
          const filterButtons = document.querySelectorAll('#status-filter-buttons button');
          const tableRows = document.querySelectorAll('tbody tr');
          let currentDeviceFilter = null; // Track device filter
          
          // Device card filtering
          const deviceCards = document.querySelectorAll('.device-summary-card');
          deviceCards.forEach(card => {
            card.addEventListener('click', function() {
              const deviceName = this.getAttribute('data-device-name');
              
              // Toggle device filter
              if (currentDeviceFilter === deviceName) {
                // Deselect - show all devices
                currentDeviceFilter = null;
                deviceCards.forEach(c => c.style.opacity = '1');
                deviceCards.forEach(c => c.style.borderLeftWidth = '4px');
              } else {
                // Select this device
                currentDeviceFilter = deviceName;
                deviceCards.forEach(c => {
                  if (c.getAttribute('data-device-name') === deviceName) {
                    c.style.opacity = '1';
                    c.style.borderLeftWidth = '6px';
                  } else {
                    c.style.opacity = '0.5';
                    c.style.borderLeftWidth = '4px';
                  }
                });
              }
              
              // Apply filters
              applyFilters();
            });
          });
          
          function applyFilters() {
            let visibleCount = 0;
            tableRows.forEach(row => {
              const details = row.querySelector('details.deployment-logs');
              const statusFilter = details ? details.getAttribute('data-status-filter') : '';
              
              // Get device name from first cell
              const cells = row.querySelectorAll('td');
              const deviceCell = cells[0];
              const deviceLink = deviceCell.querySelector('a');
              const rowDeviceName = deviceLink ? deviceLink.textContent.trim() : '';
              
              // Find Overall Status column
              let statusText = '';
              if (statusFilter) {
                statusText = statusFilter.toLowerCase(); // Normalize to lowercase
              } else {
                if (cells.length > 5) {
                  const statusCell = cells[5];
                  const badge = statusCell.querySelector('.badge');
                  if (badge) {
                    const text = badge.textContent.trim().toLowerCase();
                    // Check for common status values (case-insensitive)
                    if (text.includes('pass') || text === 'pass' || text === 'success') {
                      statusText = 'pass';
                    } else if (text.includes('warn') || text === 'warn' || text === 'warning') {
                      statusText = 'warn';
                    } else if (text.includes('block') || text === 'blocked' || text === 'error' || text === 'fail') {
                      statusText = 'blocked';
                    }
                  }
                }
              }
              
              // Get active status filter
              const activeStatusFilter = document.querySelector('#status-filter-buttons button.active');
              const statusFilterValue = activeStatusFilter ? activeStatusFilter.getAttribute('data-filter') : 'all';
              
              // Apply status filter (case-insensitive comparison)
              let show = false;
              if (statusFilterValue === 'all') {
                show = true;
              } else if (statusFilterValue === 'pass') {
                show = statusText === 'pass' || statusText === 'success';
              } else if (statusFilterValue === 'warnings') {
                show = statusText === 'warn' || statusText === 'warning';
              } else if (statusFilterValue === 'blocked') {
                show = statusText === 'blocked' || statusText === 'block' || statusText === 'error' || statusText === 'fail';
              }
              
              // Apply device filter
              if (show && currentDeviceFilter) {
                show = (rowDeviceName === currentDeviceFilter);
              }
              
              if (show) {
                row.style.display = '';
                visibleCount++;
              } else {
                row.style.display = 'none';
              }
            });
            
            console.log(`Showing ${visibleCount} of ${tableRows.length} rows`);
          }
          
          filterButtons.forEach(button => {
            button.addEventListener('click', function() {
              // Update button states
              filterButtons.forEach(btn => {
                btn.classList.remove('active', 'btn-primary');
                btn.classList.add('btn-outline-primary');
              });
              this.classList.add('active', 'btn-primary');
              this.classList.remove('btn-outline-primary');
              
              // Apply filters
              applyFilters();
            });
          });
          
          // Bulk actions: Expand All
          document.getElementById('expand-all-btn').addEventListener('click', function() {
            tableRows.forEach(row => {
              if (row.style.display !== 'none') {
                const details = row.querySelector('details.deployment-logs');
                if (details) {
                  details.open = true;
                }
              }
            });
          });
          
          // Bulk actions: Collapse All
          document.getElementById('collapse-all-btn').addEventListener('click', function() {
            tableRows.forEach(row => {
              const details = row.querySelector('details.deployment-logs');
              if (details) {
                details.open = false;
              }
            });
          });
        });
        
        // CSV download functionality
        document.getElementById('download-csv-btn').addEventListener('click', function() {
          // Get the table
          const table = document.querySelector('table');
          let csv = [];
          
          // Get headers
          const headers = [];
          table.querySelectorAll('thead th').forEach(th => {
            headers.push(th.textContent.trim());
          });
          csv.push(headers.join(','));
          
          // Get rows (only visible ones)
          table.querySelectorAll('tbody tr').forEach(tr => {
            if (tr.style.display !== 'none') {
              const row = [];
              tr.querySelectorAll('td').forEach(td => {
                // Escape quotes and wrap in quotes if contains comma
                let value = td.textContent.trim().replace(/"/g, '""');
                if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                  value = '"' + value + '"';
                }
                row.push(value);
              });
              csv.push(row.join(','));
            }
          });
          
          // Create download
          const csvContent = csv.join('\n');
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'vlan_deployment_results.csv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        });
      </script>
    </div>
  </div>
  
  {# Back to Form Button #}
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="text-center">
        <a href="{% url 'plugins:netbox_automation_plugin:vlan_deployment' %}" class="btn btn-primary">
          <i class="mdi mdi-arrow-left"></i>
          {% trans "Back to Form" %}
        </a>
      </div>
    </div>
  </div>
{% endblock %}

