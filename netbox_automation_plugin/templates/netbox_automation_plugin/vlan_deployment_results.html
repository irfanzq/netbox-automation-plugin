{% extends 'base/layout.html' %}
{% load i18n %}
{% load render_table from django_tables2 %}
{% load form_helpers %}

{% block title %}{% trans "VLAN Deployment Results" %}{% endblock %}

{% block content %}
<style>
  /* Dark mode compatible styles - NO GREY TEXT! */
  
  /* Card text - Black in light, White in dark */
  .card-body,
  .card-body *:not(input):not(select):not(textarea):not(button):not(.form-control):not(.form-select):not(.btn):not(.badge) {
    color: #212529 !important;
  }
  
  html[data-theme="dark"] .card-body,
  html[data-theme="dark"] .card-body *:not(input):not(select):not(textarea):not(button):not(.form-control):not(.form-select):not(.btn):not(.badge),
  body.dark-mode .card-body,
  body.dark-mode .card-body *:not(input):not(select):not(textarea):not(button):not(.form-control):not(.form-select):not(.btn):not(.badge) {
    color: #ffffff !important;
  }
  
  /* Text elements - NO GREY TEXT! */
  .card-body .form-label, .card-body label, .card-body p, .card-body div:not(.badge), .card-body span:not(.badge), .card-body small,
  .card-body h1, .card-body h2, .card-body h3, .card-body h4, .card-body h5, .card-body h6,
  .card-body .card-title, .card-body dt, .card-body dd,
  .card-header, .card-header h5, .card-header .card-title {
    color: #212529 !important;
  }

  html[data-theme="dark"] .card-body .form-label, html[data-theme="dark"] .card-body label, html[data-theme="dark"] .card-body p,
  html[data-theme="dark"] .card-body div:not(.badge), html[data-theme="dark"] .card-body span:not(.badge), html[data-theme="dark"] .card-body small,
  html[data-theme="dark"] .card-body h1, html[data-theme="dark"] .card-body h2, html[data-theme="dark"] .card-body h3,
  html[data-theme="dark"] .card-body h4, html[data-theme="dark"] .card-body h5, html[data-theme="dark"] .card-body h6,
  html[data-theme="dark"] .card-body .card-title, html[data-theme="dark"] .card-body dt, html[data-theme="dark"] .card-body dd,
  html[data-theme="dark"] .card-header, html[data-theme="dark"] .card-header h5, html[data-theme="dark"] .card-header .card-title,
  body.dark-mode .card-body .form-label, body.dark-mode .card-body label, body.dark-mode .card-body p,
  body.dark-mode .card-body div:not(.badge), body.dark-mode .card-body span:not(.badge), body.dark-mode .card-body small,
  body.dark-mode .card-body h1, body.dark-mode .card-body h2, body.dark-mode .card-body h3,
  body.dark-mode .card-body h4, body.dark-mode .card-body h5, body.dark-mode .card-body h6,
  body.dark-mode .card-body .card-title, body.dark-mode .card-body dt, body.dark-mode .card-body dd,
  body.dark-mode .card-header, body.dark-mode .card-header h5, body.dark-mode .card-header .card-title {
    color: #ffffff !important;
  }
  
  /* text-muted - NO GREY: Black in light, White in dark */
  .text-muted, p.text-muted, label.text-muted, small.text-muted, td.text-muted, span.text-muted {
    color: #212529 !important;
    opacity: 1 !important;
  }
  
  html[data-theme="dark"] .text-muted, html[data-theme="dark"] p.text-muted, html[data-theme="dark"] label.text-muted,
  html[data-theme="dark"] small.text-muted, html[data-theme="dark"] td.text-muted, html[data-theme="dark"] span.text-muted,
  body.dark-mode .text-muted, body.dark-mode p.text-muted, body.dark-mode label.text-muted,
  body.dark-mode small.text-muted, body.dark-mode td.text-muted, body.dark-mode span.text-muted {
    color: #ffffff !important;
    opacity: 1 !important;
  }
  
  /* Table text */
  .table, .table td, .table th {
    color: #212529 !important;
  }
  
  html[data-theme="dark"] .table, html[data-theme="dark"] .table td, html[data-theme="dark"] .table th,
  body.dark-mode .table, body.dark-mode .table td, body.dark-mode .table th {
    color: #ffffff !important;
  }
  
  /* Colored text - brighter in dark mode */
  .text-success { color: #198754 !important; }
  html[data-theme="dark"] .text-success, body.dark-mode .text-success { color: #75d175 !important; }
  
  .text-info { color: #0dcaf0 !important; }
  html[data-theme="dark"] .text-info, body.dark-mode .text-info { color: #6ec9f0 !important; }
  
  .text-danger { color: #dc3545 !important; }
  html[data-theme="dark"] .text-danger, body.dark-mode .text-danger { color: #ff6b7a !important; }
  
  .text-warning { color: #856404 !important; }
  html[data-theme="dark"] .text-warning, body.dark-mode .text-warning { color: #ffd966 !important; }
  
  /* Badges */
  .badge { color: #ffffff !important; }
  .badge.bg-warning { color: #000000 !important; }
  
  /* Filter buttons - proper visibility with filled dot when active */
  .btn-outline-primary {
    color: #0d6efd !important;
    border-color: #0d6efd !important;
    background-color: transparent !important;
  }
  
  html[data-theme="dark"] .btn-outline-primary,
  body.dark-mode .btn-outline-primary {
    color: #4da6ff !important;
    border-color: #4da6ff !important;
  }
  
  .btn-outline-primary.active,
  .btn-primary.active,
  .btn-primary {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: #ffffff !important;
  }
  
  /* Bulk action buttons (Expand All / Collapse All) - Light grey background with dark text */
  #bulk-action-buttons .btn {
    color: var(--nbx-color-fg-default, #212529) !important; /* Dark text for readability */
    background-color: var(--nbx-color-bg-secondary, #e9ecef) !important; /* Light grey background */
    border-color: var(--nbx-color-border-default, #ced4da) !important;
  }

  /* In dark mode, keep light grey background but use dark text for contrast */
  html[data-theme="dark"] #bulk-action-buttons .btn,
  body.dark-mode #bulk-action-buttons .btn {
    color: var(--nbx-color-fg-default, #212529) !important; /* Dark text on light grey background */
    background-color: var(--nbx-color-bg-secondary, #e9ecef) !important; /* Light grey background */
    border-color: var(--nbx-color-border-default, #ced4da) !important;
  }
  
  /* Ensure icons inside buttons also have dark text */
  #bulk-action-buttons .btn i {
    color: var(--nbx-color-fg-default, #212529) !important;
  }
  
  html[data-theme="dark"] #bulk-action-buttons .btn i,
  body.dark-mode #bulk-action-buttons .btn i {
    color: var(--nbx-color-fg-default, #212529) !important; /* Dark icon on light grey background */
  }
</style>
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">{% trans "VLAN Deployment Summary" %}</h5>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-md-3">{% trans "Devices" %}</dt>
            <dd class="col-md-3">{{ summary.device_count }}</dd>

            <dt class="col-md-3">{% trans "Interfaces" %}</dt>
            <dd class="col-md-3">{{ summary.interface_count }}</dd>

            <dt class="col-md-3 text-success">{% trans "Successful" %}</dt>
            <dd class="col-md-3 text-success">{{ summary.success }}</dd>

            <dt class="col-md-3 text-info">{% trans "Dry Run" %}</dt>
            <dd class="col-md-3 text-info">{{ summary.dry_run }}</dd>

            <dt class="col-md-3 text-danger">{% trans "Errors" %}</dt>
            <dd class="col-md-3 text-danger">{{ summary.error }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  {# Device Summary Cards #}
  {% if device_summaries %}
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">{% trans "Device Summary" %}</h5>
        </div>
        <div class="card-body">
          <div class="row">
            {% for device_summary in device_summaries %}
            <div class="col-md-3 mb-2">
              <div class="card device-summary-card" 
                   data-device-name="{{ device_summary.device_name }}"
                   style="cursor: pointer; border-left: 4px solid {% if device_summary.device_status == 'pass' %}#198754{% elif device_summary.device_status == 'warn' %}#ffc107{% else %}#dc3545{% endif %};">
                <div class="card-body p-2">
                  <h6 class="mb-1">
                    {% if device_summary.device and device_summary.device.pk %}
                      <a href="{% url 'dcim:device' pk=device_summary.device.pk %}" onclick="event.stopPropagation();">{{ device_summary.device_name }}</a>
                    {% else %}
                      <span>{{ device_summary.device_name }}</span>
                    {% endif %}
                  </h6>
                  <div class="small">
                    <span class="badge bg-secondary">{{ device_summary.total }} total</span>
                    <span class="badge bg-success">{{ device_summary.pass }} pass</span>
                    {% if device_summary.warn > 0 %}
                    <span class="badge bg-warning text-dark">{{ device_summary.warn }} warn</span>
                    {% endif %}
                    {% if device_summary.blocked > 0 %}
                    <span class="badge bg-danger">{{ device_summary.blocked }} blocked</span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">{% trans "VLAN Deployment Results" %}</h5>
          <div>
            <div class="btn-group btn-group-sm me-2" role="group" id="status-filter-buttons">
              <button type="button" class="btn btn-primary active" data-filter="all">
                All{% if status_counts.total %} ({{ status_counts.total }}){% endif %}
              </button>
              <button type="button" class="btn btn-outline-primary" data-filter="pass">
                Pass Only{% if status_counts.pass %} ({{ status_counts.pass }}){% endif %}
              </button>
              <button type="button" class="btn btn-outline-primary" data-filter="warnings">
                Warnings Only{% if status_counts.warn %} ({{ status_counts.warn }}){% endif %}
              </button>
              <button type="button" class="btn btn-outline-primary" data-filter="blocked">
                Blocked Only{% if status_counts.blocked %} ({{ status_counts.blocked }}){% endif %}
              </button>
            </div>
            <div class="btn-group btn-group-sm me-2" role="group" id="bulk-action-buttons">
              <button type="button" class="btn" id="expand-all-btn" title="Expand all deployment log details">
                <i class="mdi mdi-unfold-more-horizontal"></i> Expand All
              </button>
              <button type="button" class="btn" id="collapse-all-btn" title="Collapse all deployment log details">
                <i class="mdi mdi-unfold-less-horizontal"></i> Collapse All
              </button>
            </div>
            <button type="button" id="download-csv-btn" class="btn btn-sm btn-secondary">
              <i class="mdi mdi-download"></i>
              {% trans "Download CSV" %}
            </button>
          </div>
        </div>
        <div class="card-body table-responsive">
          {% render_table table %}
        </div>
      </div>
      
      <script>
        // NetBox Theme Detection and Color Application
        function getNetBoxTheme() {
          try {
            return localStorage.getItem('netbox-color-mode') || 'light';
          } catch (e) {
            // Fallback: check if NetBox has set data-theme attribute
            const htmlEl = document.documentElement;
            if (htmlEl && htmlEl.getAttribute('data-theme') === 'dark') {
              return 'dark';
            }
            if (document.body && document.body.classList.contains('dark-mode')) {
              return 'dark';
            }
            return 'light';
          }
        }
        
        function isDarkMode() {
          return getNetBoxTheme() === 'dark';
        }
        
        function applyThemeColors() {
          const darkMode = isDarkMode();
          const textColor = darkMode ? '#ffffff' : '#212529';
          const bgColor = darkMode ? '#2a2a2a' : '#f5f5f5';

          // Apply to all text elements in card-body (excluding badges and colored text classes)
          document.querySelectorAll('.card-body p, .card-body label, .card-body span:not(.badge), .card-body small, .card-body div:not(.badge), .card-body .form-text, .card-body .text-muted, .card-body h1, .card-body h2, .card-body h3, .card-body h4, .card-body h5, .card-body h6, .card-body dt, .card-body dd').forEach(el => {
            // Skip badges and colored text classes (they have their own styling)
            if (!el.classList.contains('badge') && 
                !el.classList.contains('text-success') && 
                !el.classList.contains('text-info') && 
                !el.classList.contains('text-danger') && 
                !el.classList.contains('text-warning')) {
              el.style.setProperty('color', textColor, 'important');
              if (el.classList.contains('text-muted') || el.classList.contains('form-text')) {
                el.style.setProperty('opacity', '1', 'important');
              }
            }
          });

          // Apply to card header
          document.querySelectorAll('.card-header, .card-header h5, .card-header .card-title').forEach(el => {
            el.style.setProperty('color', textColor, 'important');
          });

          // Apply to deployment logs - ALL text inside
          document.querySelectorAll('.deployment-logs div').forEach(el => {
            el.style.setProperty('background-color', bgColor, 'important');
            el.style.setProperty('color', textColor, 'important');
          });

          // Apply to ALL text inside deployment logs
          document.querySelectorAll('.deployment-logs div *').forEach(el => {
            el.style.setProperty('color', textColor, 'important');
          });

          // Apply to code/pre blocks
          document.querySelectorAll('.deployment-logs div pre, .deployment-logs div code').forEach(el => {
            el.style.setProperty('background-color', darkMode ? '#1a1a1a' : '#e9ecef', 'important');
            el.style.setProperty('color', textColor, 'important');
          });

          // Apply to table text
          document.querySelectorAll('.table td, .table th').forEach(el => {
            el.style.setProperty('color', textColor, 'important');
          });

          // Apply to summary section (dt/dd) - preserve color classes in both modes
          document.querySelectorAll('dt, dd').forEach(el => {
            // Apply appropriate colors based on color classes in both light and dark mode
            if (el.classList.contains('text-success')) {
              el.style.setProperty('color', darkMode ? '#75d175' : '#198754', 'important');
            } else if (el.classList.contains('text-info')) {
              el.style.setProperty('color', darkMode ? '#6ec9f0' : '#0dcaf0', 'important');
            } else if (el.classList.contains('text-danger')) {
              el.style.setProperty('color', darkMode ? '#ff6b7a' : '#dc3545', 'important');
            } else if (el.classList.contains('text-warning')) {
              el.style.setProperty('color', darkMode ? '#ffd966' : '#856404', 'important');
            } else {
              // No color class - use default text color
              el.style.setProperty('color', textColor, 'important');
            }
          });

          // Apply to buttons (but exclude bulk action buttons which have their own styling)
          document.querySelectorAll('.btn:not(.btn-primary):not(.btn-secondary):not(#bulk-action-buttons .btn)').forEach(el => {
            // Skip bulk action buttons - they have light grey background with dark text in both modes
            if (el.closest('#bulk-action-buttons')) {
              return;
            }
            if (!el.classList.contains('btn-outline-primary') && !el.classList.contains('btn-outline-secondary')) {
              el.style.setProperty('color', textColor, 'important');
            }
          });
          
          // Ensure bulk action buttons always have dark text on light grey background
          document.querySelectorAll('#bulk-action-buttons .btn').forEach(el => {
            el.style.setProperty('color', '#212529', 'important'); // Dark text
            el.style.setProperty('background-color', '#e9ecef', 'important'); // Light grey background
            el.style.setProperty('border-color', '#ced4da', 'important');
          });
          
          // Ensure icons in bulk action buttons also have dark text
          document.querySelectorAll('#bulk-action-buttons .btn i').forEach(el => {
            el.style.setProperty('color', '#212529', 'important'); // Dark icon
          });

          // Apply to badges (keep their specific colors but ensure text is visible)
          document.querySelectorAll('.badge').forEach(el => {
            if (el.classList.contains('bg-warning')) {
              el.style.setProperty('color', '#000000', 'important'); // Black text on yellow
            } else {
              el.style.setProperty('color', '#ffffff', 'important'); // White text on colored badges
            }
          });

          // Apply to form text elements globally
          document.querySelectorAll('.form-text, .text-muted, small').forEach(el => {
            if (!el.classList.contains('badge')) {
              el.style.setProperty('color', textColor, 'important');
              el.style.setProperty('opacity', '1', 'important');
            }
          });
        }
        
        // Apply on page load
        document.addEventListener('DOMContentLoaded', function() {
          applyThemeColors();
          
          // Listen for NetBox theme changes
          window.addEventListener('netbox.colorModeChanged', function(e) {
            setTimeout(applyThemeColors, 100);
          });
          
          // Also check periodically in case theme changes
          setInterval(applyThemeColors, 2000);
        });
      </script>

      <script>
        // Status filter functionality
        document.addEventListener('DOMContentLoaded', function() {
          const filterButtons = document.querySelectorAll('#status-filter-buttons button');
          const tableRows = document.querySelectorAll('tbody tr');
          let currentDeviceFilter = null; // Track device filter
          
          // Device card filtering
          const deviceCards = document.querySelectorAll('.device-summary-card');
          deviceCards.forEach(card => {
            card.addEventListener('click', function() {
              const deviceName = this.getAttribute('data-device-name');
              
              // Toggle device filter
              if (currentDeviceFilter === deviceName) {
                // Deselect - show all devices
                currentDeviceFilter = null;
                deviceCards.forEach(c => c.style.opacity = '1');
                deviceCards.forEach(c => c.style.borderLeftWidth = '4px');
              } else {
                // Select this device
                currentDeviceFilter = deviceName;
                deviceCards.forEach(c => {
                  if (c.getAttribute('data-device-name') === deviceName) {
                    c.style.opacity = '1';
                    c.style.borderLeftWidth = '6px';
                  } else {
                    c.style.opacity = '0.5';
                    c.style.borderLeftWidth = '4px';
                  }
                });
              }
              
              // Apply filters
              applyFilters();
            });
          });
          
          function applyFilters() {
            let visibleCount = 0;
            tableRows.forEach(row => {
              const details = row.querySelector('details.deployment-logs');
              const statusFilter = details ? details.getAttribute('data-status-filter') : '';
              
              // Get device name from first cell
              const cells = row.querySelectorAll('td');
              const deviceCell = cells[0];
              const deviceLink = deviceCell.querySelector('a');
              const rowDeviceName = deviceLink ? deviceLink.textContent.trim() : '';
              
              // Find Overall Status column
              let statusText = '';
              if (statusFilter) {
                statusText = statusFilter.toLowerCase(); // Normalize to lowercase
              } else {
                if (cells.length > 5) {
                  const statusCell = cells[5];
                  const badge = statusCell.querySelector('.badge');
                  if (badge) {
                    const text = badge.textContent.trim().toLowerCase();
                    // Check for common status values (case-insensitive)
                    if (text.includes('pass') || text === 'pass' || text === 'success') {
                      statusText = 'pass';
                    } else if (text.includes('warn') || text === 'warn' || text === 'warning') {
                      statusText = 'warn';
                    } else if (text.includes('block') || text === 'blocked' || text === 'error' || text === 'fail') {
                      statusText = 'blocked';
                    }
                  }
                }
              }
              
              // Get active status filter
              const activeStatusFilter = document.querySelector('#status-filter-buttons button.active');
              const statusFilterValue = activeStatusFilter ? activeStatusFilter.getAttribute('data-filter') : 'all';
              
              // Apply status filter (case-insensitive comparison)
              let show = false;
              if (statusFilterValue === 'all') {
                show = true;
              } else if (statusFilterValue === 'pass') {
                show = statusText === 'pass' || statusText === 'success';
              } else if (statusFilterValue === 'warnings') {
                show = statusText === 'warn' || statusText === 'warning';
              } else if (statusFilterValue === 'blocked') {
                show = statusText === 'blocked' || statusText === 'block' || statusText === 'error' || statusText === 'fail';
              }
              
              // Apply device filter
              if (show && currentDeviceFilter) {
                show = (rowDeviceName === currentDeviceFilter);
              }
              
              if (show) {
                row.style.display = '';
                visibleCount++;
              } else {
                row.style.display = 'none';
              }
            });
            
            console.log(`Showing ${visibleCount} of ${tableRows.length} rows`);
          }
          
          filterButtons.forEach(button => {
            button.addEventListener('click', function() {
              // Update button states
              filterButtons.forEach(btn => {
                btn.classList.remove('active', 'btn-primary');
                btn.classList.add('btn-outline-primary');
              });
              this.classList.add('active', 'btn-primary');
              this.classList.remove('btn-outline-primary');
              
              // Apply filters
              applyFilters();
            });
          });
          
          // Bulk actions: Expand All
          document.getElementById('expand-all-btn').addEventListener('click', function() {
            tableRows.forEach(row => {
              if (row.style.display !== 'none') {
                const details = row.querySelector('details.deployment-logs');
                if (details) {
                  details.open = true;
                }
              }
            });
          });
          
          // Bulk actions: Collapse All
          document.getElementById('collapse-all-btn').addEventListener('click', function() {
            tableRows.forEach(row => {
              const details = row.querySelector('details.deployment-logs');
              if (details) {
                details.open = false;
              }
            });
          });
        });
        
        // CSV download functionality
        document.getElementById('download-csv-btn').addEventListener('click', function() {
          // Get the table
          const table = document.querySelector('table');
          let csv = [];
          
          // Get headers
          const headers = [];
          table.querySelectorAll('thead th').forEach(th => {
            headers.push(th.textContent.trim());
          });
          csv.push(headers.join(','));
          
          // Get rows (only visible ones)
          table.querySelectorAll('tbody tr').forEach(tr => {
            if (tr.style.display !== 'none') {
              const row = [];
              tr.querySelectorAll('td').forEach(td => {
                // Escape quotes and wrap in quotes if contains comma
                let value = td.textContent.trim().replace(/"/g, '""');
                if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                  value = '"' + value + '"';
                }
                row.push(value);
              });
              csv.push(row.join(','));
            }
          });
          
          // Create download
          const csvContent = csv.join('\n');
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'vlan_deployment_results.csv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        });
      </script>
    </div>
  </div>
  
  {# Back to Form Button #}
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="text-center">
        <a href="{% url 'plugins:netbox_automation_plugin:vlan_deployment' %}" class="btn btn-primary">
          <i class="mdi mdi-arrow-left"></i>
          {% trans "Back to Form" %}
        </a>
      </div>
    </div>
  </div>
{% endblock %}

