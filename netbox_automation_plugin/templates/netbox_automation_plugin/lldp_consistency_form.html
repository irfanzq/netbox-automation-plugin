{% extends 'base/layout.html' %}
{% load i18n %}
{% load form_helpers %}

{% block title %}{% trans "LLDP Consistency Check" %}{% endblock %}

{% block content %}
<style>
  /* Dark mode compatibility for LLDP Consistency Form */
  /* Use NetBox CSS variables with explicit fallbacks - NO GREY! */
  
  /* Use NetBox CSS variables - they adapt to theme automatically */
  .card-body,
  .card-body *:not(input):not(select):not(textarea):not(button):not(.form-control):not(.form-select):not(.btn):not(.badge) {
    color: var(--nbx-color-fg-default) !important;
  }
  
  /* Force visibility - ensure text is never grey */
  .card-body .text-muted,
  .card-body .form-text,
  .card-body small {
    color: var(--nbx-color-fg-default) !important;
    opacity: 1 !important;
  }
  
  /* Specific overrides for common text elements */
  .card-body .form-label,
  .card-body label:not(.form-check-label),
  .card-body .form-check-label,
  .card-body p,
  .card-body div.form-text,
  .card-body span,
  .card-body small,
  .card-body h1,
  .card-body h2,
  .card-body h3,
  .card-body h4,
  .card-body h5,
  .card-body h6,
  .card-body .card-title {
    color: var(--nbx-color-fg-default, #212529) !important;
  }
  
  /* Dark mode overrides */
  html[data-theme="dark"] .card-body .form-label,
  html[data-theme="dark"] .card-body label:not(.form-check-label),
  html[data-theme="dark"] .card-body .form-check-label,
  html[data-theme="dark"] .card-body p,
  html[data-theme="dark"] .card-body div.form-text,
  html[data-theme="dark"] .card-body span,
  html[data-theme="dark"] .card-body small,
  html[data-theme="dark"] .card-body h1,
  html[data-theme="dark"] .card-body h2,
  html[data-theme="dark"] .card-body h3,
  html[data-theme="dark"] .card-body h4,
  html[data-theme="dark"] .card-body h5,
  html[data-theme="dark"] .card-body h6,
  html[data-theme="dark"] .card-body .card-title,
  body.dark-mode .card-body .form-label,
  body.dark-mode .card-body label:not(.form-check-label),
  body.dark-mode .card-body .form-check-label,
  body.dark-mode .card-body p,
  body.dark-mode .card-body div.form-text,
  body.dark-mode .card-body span,
  body.dark-mode .card-body small,
  body.dark-mode .card-body h1,
  body.dark-mode .card-body h2,
  body.dark-mode .card-body h3,
  body.dark-mode .card-body h4,
  body.dark-mode .card-body h5,
  body.dark-mode .card-body h6,
  body.dark-mode .card-body .card-title {
    color: #ffffff !important; /* White for dark mode */
  }
  
  /* Help text and muted text - NO GREY: Black in light, White in dark */
  .card-body .form-text,
  .card-body .text-muted,
  .card-body p.text-muted,
  .card-body label.text-muted,
  .card-body small.text-muted,
  .form-text,
  .text-muted,
  p.text-muted,
  label.text-muted,
  small.text-muted,
  small {
    color: #212529 !important; /* Black for light mode */
    opacity: 1 !important;
  }
  
  html[data-theme="dark"] .card-body .form-text,
  html[data-theme="dark"] .card-body .text-muted,
  html[data-theme="dark"] .card-body p.text-muted,
  html[data-theme="dark"] .card-body label.text-muted,
  html[data-theme="dark"] .card-body small.text-muted,
  html[data-theme="dark"] .form-text,
  html[data-theme="dark"] .text-muted,
  html[data-theme="dark"] p.text-muted,
  html[data-theme="dark"] label.text-muted,
  html[data-theme="dark"] small.text-muted,
  html[data-theme="dark"] small,
  body.dark-mode .card-body .form-text,
  body.dark-mode .card-body .text-muted,
  body.dark-mode .card-body p.text-muted,
  body.dark-mode .card-body label.text-muted,
  body.dark-mode .card-body small.text-muted,
  body.dark-mode .form-text,
  body.dark-mode .text-muted,
  body.dark-mode p.text-muted,
  body.dark-mode label.text-muted,
  body.dark-mode small.text-muted,
  body.dark-mode small {
    color: #ffffff !important; /* White for dark mode */
    opacity: 1 !important;
  }
  
  /* Card header text */
  .card-header,
  .card-header * {
    color: #212529 !important; /* Black for light mode */
  }
  
  html[data-theme="dark"] .card-header,
  html[data-theme="dark"] .card-header *,
  body.dark-mode .card-header,
  body.dark-mode .card-header * {
    color: #ffffff !important; /* White for dark mode */
  }
  
  /* Force white background and black text in dark mode - highest specificity */
  html[data-theme="dark"] .form-control,
  html[data-theme="dark"] .form-select,
  html[data-theme="dark"] select.form-control,
  html[data-theme="dark"] select.form-select,
  html[data-theme="dark"] textarea.form-control,
  html[data-theme="dark"] input[type="text"],
  html[data-theme="dark"] input[type="number"],
  html[data-theme="dark"] input[type="email"],
  html[data-theme="dark"] input[type="password"],
  html[data-theme="dark"] input[type="search"],
  html[data-theme="dark"] input.form-control,
  html[data-theme="dark"] textarea,
  html[data-theme="dark"] .card-body .form-control,
  html[data-theme="dark"] .card-body input[type="text"],
  html[data-theme="dark"] .card-body input[type="number"],
  html[data-theme="dark"] .card-body textarea,
  body.dark-mode .form-control,
  body.dark-mode .form-select,
  body.dark-mode select.form-control,
  body.dark-mode select.form-select,
  body.dark-mode textarea.form-control,
  body.dark-mode input[type="text"],
  body.dark-mode input[type="number"],
  body.dark-mode input[type="email"],
  body.dark-mode input[type="password"],
  body.dark-mode input[type="search"],
  body.dark-mode input.form-control,
  body.dark-mode textarea,
  body.dark-mode .card-body .form-control,
  body.dark-mode .card-body input[type="text"],
  body.dark-mode .card-body input[type="number"],
  body.dark-mode .card-body textarea {
    background-color: #ffffff !important; /* White background in dark mode */
    color: #212529 !important; /* Black text in dark mode - force for readability */
    border-color: var(--nbx-color-border-input, #ced4da) !important;
  }
  
  .form-control,
  .form-select,
  select.form-control,
  select.form-select,
  textarea.form-control {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    color: var(--nbx-color-fg-default, #212529) !important;
    border-color: var(--nbx-color-border-input, #ced4da) !important;
  }
  
  html[data-theme="dark"] .form-control::placeholder,
  body.dark-mode .form-control::placeholder {
    color: var(--nbx-color-fg-default) !important;
    opacity: 0.7;
  }
  
  .form-control::placeholder {
    color: var(--nbx-color-fg-default, #212529) !important;
    opacity: 0.7;
  }
  
  html[data-theme="dark"] .form-control:focus,
  html[data-theme="dark"] .form-select:focus,
  html[data-theme="dark"] select.form-control:focus,
  html[data-theme="dark"] select.form-select:focus,
  html[data-theme="dark"] textarea.form-control:focus,
  html[data-theme="dark"] input[type="text"]:focus,
  html[data-theme="dark"] input[type="number"]:focus,
  html[data-theme="dark"] input.form-control:focus,
  html[data-theme="dark"] textarea:focus,
  body.dark-mode .form-control:focus,
  body.dark-mode .form-select:focus,
  body.dark-mode select.form-control:focus,
  body.dark-mode select.form-select:focus,
  body.dark-mode textarea.form-control:focus,
  body.dark-mode input[type="text"]:focus,
  body.dark-mode input[type="number"]:focus,
  body.dark-mode input.form-control:focus,
  body.dark-mode textarea:focus {
    background-color: #ffffff !important; /* White background in dark mode */
    color: #212529 !important; /* Black text in dark mode - force for readability */
    border-color: var(--nbx-color-border-input-focus, #86b7fe) !important;
  }
  
  .form-control:focus,
  .form-select:focus,
  select.form-control:focus,
  select.form-select:focus,
  textarea.form-control:focus {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    color: var(--nbx-color-fg-default, #212529) !important;
    border-color: var(--nbx-color-border-input-focus, #86b7fe) !important;
  }
  
  /* Checkbox and radio button styling */
  .form-check-input {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    border-color: var(--nbx-color-border-input, #ced4da) !important;
  }
  
  html[data-theme="dark"] .form-check-input,
  body.dark-mode .form-check-input {
    background-color: #ffffff !important; /* White background in dark mode */
    border-color: var(--nbx-color-border-input, #ced4da) !important;
  }
  
  .form-check-input:checked {
    background-color: var(--nbx-color-primary, #0d6efd) !important;
    border-color: var(--nbx-color-primary, #0d6efd) !important;
  }
  
  /* Radio button checked state in dark mode - blue background with dark dot */
  html[data-theme="dark"] .form-check-input[type="radio"]:checked,
  body.dark-mode .form-check-input[type="radio"]:checked {
    background-color: var(--nbx-color-primary, #0d6efd) !important;
    border-color: var(--nbx-color-primary, #0d6efd) !important;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='2' fill='%23212529'/%3e%3c/svg%3e") !important; /* Dark dot */
  }
  
  .form-check-input:focus {
    border-color: var(--nbx-color-border-input-focus, #86b7fe) !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }
  
  .form-check-label {
    color: var(--nbx-color-fg-default, #212529) !important;
  }
  
  /* Datalist dropdown styling */
  html[data-theme="dark"] datalist option,
  body.dark-mode datalist option {
    background-color: var(--nbx-color-bg-input) !important;
    color: var(--nbx-color-fg-default) !important;
  }
  
  datalist option {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    color: var(--nbx-color-fg-default, #212529) !important;
  }
  
  /* Select dropdown options */
  html[data-theme="dark"] select option,
  body.dark-mode select option {
    background-color: var(--nbx-color-bg-input) !important;
    color: var(--nbx-color-fg-default) !important;
  }
  
  select option {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    color: var(--nbx-color-fg-default, #212529) !important;
  }
  
  .invalid-feedback {
    color: var(--nbx-color-danger, #dc3545) !important;
  }
  
  /* Light mode: Light pink background with dark red text */
  .alert-danger {
    background-color: #f8d7da !important; /* Light pink background */
    color: #721c24 !important; /* Dark red text */
    border-color: #f5c2c7 !important;
  }
  
  /* Dark mode: Dark red background with white text */
  html[data-theme="dark"] .alert-danger,
  body.dark-mode .alert-danger {
    background-color: #5a1a1a !important; /* Dark red background */
    color: #ffffff !important; /* White text */
    border-color: #8b2635 !important;
  }
  
  /* Loading overlay - use NetBox CSS variables */
  /* Loading overlay - dark mode compatible */
  #loading-overlay h4 {
    color: #212529 !important; /* Black for light mode */
  }

  html[data-theme="dark"] #loading-overlay h4,
  body.dark-mode #loading-overlay h4 {
    color: #ffffff !important; /* White for dark mode */
  }

  #loading-overlay p {
    color: #212529 !important; /* Black for light mode */
  }

  html[data-theme="dark"] #loading-overlay p,
  body.dark-mode #loading-overlay p {
    color: #ffffff !important; /* White for dark mode */
  }
</style>
  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">{% trans "LLDP Consistency Check" %}</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">
            {% trans "Select devices (by filters or explicit list) and run a read-only LLDP consistency check between device configuration, device LLDP data, and NetBox." %}
          </p>

          {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
              {{ form.non_field_errors }}
            </div>
          {% endif %}

          <!-- Loading overlay -->
          <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center;">
            <div style="background: var(--nbx-color-bg-default, #fff); padding: 30px; border-radius: 8px; text-align: center; max-width: 400px; color: #212529;">
              <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
              </div>
              <h4 style="color: #212529;">Running LLDP Consistency Check...</h4>
              <p class="text-muted mb-0" style="color: #212529 !important; opacity: 1 !important;">Collecting LLDP data from devices. This may take some time.</p>
              <style>
                @media (prefers-color-scheme: dark) {
                  #loading-overlay > div {
                    background: #2a2a2a !important; /* Dark background in dark mode */
                  }
                  #loading-overlay h4,
                  #loading-overlay .text-muted {
                    color: #ffffff !important; /* White in dark mode */
                  }
                }
              </style>
            </div>
          </div>

          <form method="post" id="lldp-form">
            {% csrf_token %}
            {% render_form form %}

            <div class="mt-3">
              <button type="submit" class="btn btn-primary" id="run-check-btn" name="run_check" value="1">
                <i class="mdi mdi-magnify"></i>
                {% trans "Run Check" %}
              </button>
              <button type="submit" name="export_csv" value="1" class="btn btn-secondary" id="run-csv-btn">
                <i class="mdi mdi-download"></i>
                {% trans "Run & Download CSV" %}
              </button>
            </div>
          </form>

          <script>
            // NetBox Theme Detection and Color Application
            function getNetBoxTheme() {
              try {
                return localStorage.getItem('netbox-color-mode') || 'light';
              } catch (e) {
                // Fallback: check if NetBox has set data-theme attribute
                const htmlEl = document.documentElement;
                if (htmlEl && htmlEl.getAttribute('data-theme') === 'dark') {
                  return 'dark';
                }
                if (document.body && document.body.classList.contains('dark-mode')) {
                  return 'dark';
                }
                return 'light';
              }
            }
            
            function isDarkMode() {
              return getNetBoxTheme() === 'dark';
            }
            
            function applyThemeColors() {
              const darkMode = isDarkMode();
              const textColor = darkMode ? '#ffffff' : '#212529';
              const bgColor = darkMode ? '#2a2a2a' : '#f8f9fa';
              
              // Force white background and black text for ALL input fields in dark mode
              if (darkMode) {
                document.querySelectorAll('.form-control, .form-select, input[type="text"], input[type="number"], input[type="email"], input[type="password"], input[type="search"], textarea, select').forEach(el => {
                  el.style.setProperty('background-color', '#ffffff', 'important');
                  el.style.setProperty('color', '#212529', 'important');
                });
              }
              
              // Apply to ALL text elements in card-body (more comprehensive)
              const cardBody = document.querySelector('.card-body');
              if (cardBody) {
                const allTextElements = cardBody.querySelectorAll('p, label, span, small, div, h1, h2, h3, h4, h5, h6, dt, dd, li, td, th, .form-text, .text-muted, .form-label, .form-check-label');
                allTextElements.forEach(el => {
                  // Skip form controls
                  if (!el.closest('input') && !el.closest('select') && !el.closest('textarea') && !el.closest('button') && !el.classList.contains('form-control') && !el.classList.contains('form-select') && !el.classList.contains('btn')) {
                    el.style.setProperty('color', textColor, 'important');
                    if (el.classList.contains('text-muted') || el.classList.contains('form-text')) {
                      el.style.setProperty('opacity', '1', 'important');
                    }
                  }
                });
              }
              
              // Apply to card header
              document.querySelectorAll('.card-header, .card-header *').forEach(el => {
                if (!el.closest('input') && !el.closest('select') && !el.closest('textarea') && !el.closest('button')) {
                  el.style.setProperty('color', textColor, 'important');
                }
              });
              
              // Apply to loading overlay
              const loadingDiv = document.querySelector('#loading-overlay > div');
              if (loadingDiv) {
                loadingDiv.style.setProperty('background-color', darkMode ? '#2a2a2a' : '#fff', 'important');
                loadingDiv.style.setProperty('color', textColor, 'important');
              }
              
              // Apply to form text elements globally
              document.querySelectorAll('.form-text, .text-muted, small, .form-label, .form-check-label').forEach(el => {
                if (!el.closest('input') && !el.closest('select') && !el.closest('textarea') && !el.closest('button')) {
                  el.style.setProperty('color', textColor, 'important');
                  el.style.setProperty('opacity', '1', 'important');
                }
              });
            }
            
            // Apply on page load
            document.addEventListener('DOMContentLoaded', function() {
              applyThemeColors();
              
              // Listen for NetBox theme changes
              window.addEventListener('netbox.colorModeChanged', function(e) {
                setTimeout(applyThemeColors, 100);
              });
              
              // Also check periodically in case theme changes
              setInterval(applyThemeColors, 2000);
            });
            
            // Run immediately (in case DOM is already loaded)
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', applyThemeColors);
            } else {
              applyThemeColors();
            }
            
            // Use MutationObserver to catch dynamically added elements
            const observer = new MutationObserver(function(mutations) {
              applyThemeColors();
            });
            
            // Start observing when DOM is ready
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', function() {
                observer.observe(document.body, { childList: true, subtree: true });
              });
            } else {
              observer.observe(document.body, { childList: true, subtree: true });
            }
            
            // Make function available globally for dynamic elements
            window.getNetBoxTextColor = function() {
              return isDarkMode() ? '#ffffff' : '#212529';
            };
            
            document.getElementById('lldp-form').addEventListener('submit', function(e) {
              // Show loading overlay
              const overlay = document.getElementById('loading-overlay');
              overlay.style.display = 'flex';
              
              // Disable form buttons
              document.getElementById('run-check-btn').disabled = true;
              document.getElementById('run-csv-btn').disabled = true;
            });
          </script>
        </div>
      </div>
    </div>
  </div>
{% endblock %}


