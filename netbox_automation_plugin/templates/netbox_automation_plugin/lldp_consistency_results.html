{% extends 'base/layout.html' %}
{% load i18n %}
{% load render_table from django_tables2 %}
{% load form_helpers %}

{% block title %}{% trans "LLDP Consistency Check Results" %}{% endblock %}

{% block content %}
<style>
  /* Dark mode compatible styles - NO GREY TEXT! */
  
  /* Card text - Black in light, White in dark */
  .card-body,
  .card-body *:not(input):not(select):not(textarea):not(button):not(.form-control):not(.form-select):not(.btn):not(.badge) {
    color: #212529 !important;
  }
  
  html[data-theme="dark"] .card-body,
  html[data-theme="dark"] .card-body *:not(input):not(select):not(textarea):not(button):not(.form-control):not(.form-select):not(.btn):not(.badge),
  body.dark-mode .card-body,
  body.dark-mode .card-body *:not(input):not(select):not(textarea):not(button):not(.form-control):not(.form-select):not(.btn):not(.badge) {
    color: #ffffff !important;
  }
  
  /* Text elements - NO GREY TEXT! */
  .card-body .form-label, .card-body label, .card-body p, .card-body div:not(.badge), .card-body span:not(.badge), .card-body small,
  .card-body h1, .card-body h2, .card-body h3, .card-body h4, .card-body h5, .card-body h6,
  .card-body .card-title, .card-body dt, .card-body dd,
  .card-header, .card-header h5, .card-header .card-title {
    color: #212529 !important;
  }

  html[data-theme="dark"] .card-body .form-label, html[data-theme="dark"] .card-body label, html[data-theme="dark"] .card-body p,
  html[data-theme="dark"] .card-body div:not(.badge), html[data-theme="dark"] .card-body span:not(.badge), html[data-theme="dark"] .card-body small,
  html[data-theme="dark"] .card-body h1, html[data-theme="dark"] .card-body h2, html[data-theme="dark"] .card-body h3,
  html[data-theme="dark"] .card-body h4, html[data-theme="dark"] .card-body h5, html[data-theme="dark"] .card-body h6,
  html[data-theme="dark"] .card-body .card-title, html[data-theme="dark"] .card-body dt, html[data-theme="dark"] .card-body dd,
  html[data-theme="dark"] .card-header, html[data-theme="dark"] .card-header h5, html[data-theme="dark"] .card-header .card-title,
  body.dark-mode .card-body .form-label, body.dark-mode .card-body label, body.dark-mode .card-body p,
  body.dark-mode .card-body div:not(.badge), body.dark-mode .card-body span:not(.badge), body.dark-mode .card-body small,
  body.dark-mode .card-body h1, body.dark-mode .card-body h2, body.dark-mode .card-body h3,
  body.dark-mode .card-body h4, body.dark-mode .card-body h5, body.dark-mode .card-body h6,
  body.dark-mode .card-body .card-title, body.dark-mode .card-body dt, body.dark-mode .card-body dd,
  body.dark-mode .card-header, body.dark-mode .card-header h5, body.dark-mode .card-header .card-title {
    color: #ffffff !important;
  }
  
  /* text-muted - NO GREY: Black in light, White in dark */
  .text-muted, p.text-muted, label.text-muted, small.text-muted, td.text-muted, span.text-muted {
    color: #212529 !important;
    opacity: 1 !important;
  }
  
  html[data-theme="dark"] .text-muted, html[data-theme="dark"] p.text-muted, html[data-theme="dark"] label.text-muted,
  html[data-theme="dark"] small.text-muted, html[data-theme="dark"] td.text-muted, html[data-theme="dark"] span.text-muted,
  body.dark-mode .text-muted, body.dark-mode p.text-muted, body.dark-mode label.text-muted,
  body.dark-mode small.text-muted, body.dark-mode td.text-muted, body.dark-mode span.text-muted {
    color: #ffffff !important;
    opacity: 1 !important;
  }
  
  /* Table text */
  .table, .table td, .table th {
    color: #212529 !important;
  }
  
  html[data-theme="dark"] .table, html[data-theme="dark"] .table td, html[data-theme="dark"] .table th,
  body.dark-mode .table, body.dark-mode .table td, body.dark-mode .table th {
    color: #ffffff !important;
  }
  
  /* Colored text - brighter in dark mode */
  .text-success { color: #198754 !important; }
  html[data-theme="dark"] .text-success, body.dark-mode .text-success { color: #75d175 !important; }
  
  .text-info { color: #0dcaf0 !important; }
  html[data-theme="dark"] .text-info, body.dark-mode .text-info { color: #6ec9f0 !important; }
  
  .text-danger { color: #dc3545 !important; }
  html[data-theme="dark"] .text-danger, body.dark-mode .text-danger { color: #ff6b7a !important; }
  
  .text-warning { color: #856404 !important; }
  html[data-theme="dark"] .text-warning, body.dark-mode .text-warning { color: #ffd966 !important; }
  
  /* Badges */
  .badge { color: #ffffff !important; }
  .badge.bg-warning { color: #000000 !important; }
  
  /* Filter buttons - proper visibility with filled dot when active */
  .btn-outline-primary {
    color: #0d6efd !important;
    border-color: #0d6efd !important;
    background-color: transparent !important;
  }
  
  html[data-theme="dark"] .btn-outline-primary,
  body.dark-mode .btn-outline-primary {
    color: #4da6ff !important;
    border-color: #4da6ff !important;
  }
  
  .btn-outline-primary.active,
  .btn-primary.active,
  .btn-primary {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: #ffffff !important;
  }
</style>
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">{% trans "LLDP Consistency Check Summary" %}</h5>
          <small class="text-muted">Code executed at: {{ code_version }}</small>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-md-3">{% trans "Devices checked" %}</dt>
            <dd class="col-md-3">{{ summary.device_count }}</dd>

            <dt class="col-md-3">{% trans "Interfaces with LLDP" %}</dt>
            <dd class="col-md-3">{{ summary.interface_count }}</dd>

            <dt class="col-md-3 text-success">{% trans "OK" %}</dt>
            <dd class="col-md-3 text-success">{{ summary.ok }}</dd>

            <dt class="col-md-3 text-warning">{% trans "Warnings" %}</dt>
            <dd class="col-md-3 text-warning">{{ summary.warning }}</dd>

            <dt class="col-md-3 text-danger">{% trans "Errors" %}</dt>
            <dd class="col-md-3 text-danger">{{ summary.error }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">{% trans "LLDP Consistency Results" %}</h5>
          <button type="button" id="download-csv-btn" class="btn btn-sm btn-secondary">
            <i class="mdi mdi-download"></i>
            {% trans "Download CSV" %}
          </button>
        </div>
        <div class="card-body table-responsive">
          {% render_table table %}
        </div>
      </div>
      
      <!-- Hidden form for CSV export (uses cached results from session) -->
      <form method="post" id="csv-export-form" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="export_csv" value="1">
      </form>

      <script>
        // NetBox Theme Detection and Color Application
        function getNetBoxTheme() {
          try {
            return localStorage.getItem('netbox-color-mode') || 'light';
          } catch (e) {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
          }
        }
        
        function isDarkMode() {
          return getNetBoxTheme() === 'dark';
        }
        
        function applyThemeColors() {
          const darkMode = isDarkMode();
          const textColor = darkMode ? '#ffffff' : '#212529';
          
          // Apply to all text elements in card-body
          document.querySelectorAll('.card-body p, .card-body label, .card-body span, .card-body small, .card-body div, .card-body .form-text, .card-body .text-muted, .card-body h1, .card-body h2, .card-body h3, .card-body h4, .card-body h5, .card-body h6, .card-body dt, .card-body dd').forEach(el => {
            el.style.setProperty('color', textColor, 'important');
            if (el.classList.contains('text-muted') || el.classList.contains('form-text')) {
              el.style.setProperty('opacity', '1', 'important');
            }
          });
          
          // Apply to card header
          document.querySelectorAll('.card-header, .card-header *').forEach(el => {
            el.style.setProperty('color', textColor, 'important');
          });
          
          // Apply to form text elements globally
          document.querySelectorAll('.form-text, .text-muted, small').forEach(el => {
            el.style.setProperty('color', textColor, 'important');
            el.style.setProperty('opacity', '1', 'important');
          });
        }
        
        // Apply on page load
        document.addEventListener('DOMContentLoaded', function() {
          applyThemeColors();
          
          // Listen for NetBox theme changes
          window.addEventListener('netbox.colorModeChanged', function(e) {
            setTimeout(applyThemeColors, 100);
          });
          
          // Also check periodically in case theme changes
          setInterval(applyThemeColors, 2000);
        });
        
      <script>
        document.getElementById('download-csv-btn').addEventListener('click', function() {
          // Submit the hidden form to trigger server-side CSV export from cached results
          document.getElementById('csv-export-form').submit();
        });
      </script>
    </div>
  </div>
{% endblock %}


