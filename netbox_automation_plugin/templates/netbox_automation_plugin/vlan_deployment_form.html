{% extends 'base/layout.html' %}
{% load i18n %}
{% load form_helpers %}

{% block title %}{% trans "VLAN Deployment" %}{% endblock %}

{% block content %}
<style>
  /* Dark mode compatibility for VLAN Deployment Form */
  /* Use NetBox CSS variables with explicit fallbacks - NO GREY! */
  
  /* Use NetBox CSS variables - they adapt to theme automatically */
  .card-body,
  .card-body *:not(input):not(select):not(textarea):not(button):not(.form-control):not(.form-select):not(.btn):not(.badge) {
    color: var(--nbx-color-fg-default) !important;
  }
  
  /* Force visibility - ensure text is never grey */
  .card-body .text-muted,
  .card-body .form-text,
  .card-body small {
    color: var(--nbx-color-fg-default) !important;
    opacity: 1 !important;
  }
  
  /* Specific overrides for common text elements */
  .card-body .form-label,
  .card-body label:not(.form-check-label),
  .card-body .form-check-label,
  .card-body p,
  .card-body div.form-text,
  .card-body span,
  .card-body small,
  .card-body h1,
  .card-body h2,
  .card-body h3,
  .card-body h4,
  .card-body h5,
  .card-body h6,
  .card-body .card-title {
    color: var(--nbx-color-fg-default, #212529) !important;
  }
  
  /* Dark mode overrides */
  html[data-theme="dark"] .card-body .form-label,
  html[data-theme="dark"] .card-body label:not(.form-check-label),
  html[data-theme="dark"] .card-body .form-check-label,
  html[data-theme="dark"] .card-body p,
  html[data-theme="dark"] .card-body div.form-text,
  html[data-theme="dark"] .card-body span,
  html[data-theme="dark"] .card-body small,
  html[data-theme="dark"] .card-body h1,
  html[data-theme="dark"] .card-body h2,
  html[data-theme="dark"] .card-body h3,
  html[data-theme="dark"] .card-body h4,
  html[data-theme="dark"] .card-body h5,
  html[data-theme="dark"] .card-body h6,
  html[data-theme="dark"] .card-body .card-title,
  body.dark-mode .card-body .form-label,
  body.dark-mode .card-body label:not(.form-check-label),
  body.dark-mode .card-body .form-check-label,
  body.dark-mode .card-body p,
  body.dark-mode .card-body div.form-text,
  body.dark-mode .card-body span,
  body.dark-mode .card-body small,
  body.dark-mode .card-body h1,
  body.dark-mode .card-body h2,
  body.dark-mode .card-body h3,
  body.dark-mode .card-body h4,
  body.dark-mode .card-body h5,
  body.dark-mode .card-body h6,
  body.dark-mode .card-body .card-title {
    color: var(--nbx-color-fg-default, #ffffff) !important; /* White for dark mode */
  }
  
  /* Already covered by html[data-theme="dark"] and body.dark-mode selectors above */
  
  /* Help text and muted text - NO GREY: Black in light, White in dark */
  .card-body .form-text,
  .card-body .text-muted,
  .card-body p.text-muted,
  .card-body label.text-muted,
  .card-body small.text-muted,
  .form-text,
  .text-muted,
  p.text-muted,
  label.text-muted,
  small.text-muted,
  small {
    color: #212529 !important; /* Black for light mode */
    opacity: 1 !important;
  }
  
  html[data-theme="dark"] .card-body .form-text,
  html[data-theme="dark"] .card-body .text-muted,
  html[data-theme="dark"] .card-body p.text-muted,
  html[data-theme="dark"] .card-body label.text-muted,
  html[data-theme="dark"] .card-body small.text-muted,
  html[data-theme="dark"] .form-text,
  html[data-theme="dark"] .text-muted,
  html[data-theme="dark"] p.text-muted,
  html[data-theme="dark"] label.text-muted,
  html[data-theme="dark"] small.text-muted,
  html[data-theme="dark"] small,
  body.dark-mode .card-body .form-text,
  body.dark-mode .card-body .text-muted,
  body.dark-mode .card-body p.text-muted,
  body.dark-mode .card-body label.text-muted,
  body.dark-mode .card-body small.text-muted,
  body.dark-mode .form-text,
  body.dark-mode .text-muted,
  body.dark-mode p.text-muted,
  body.dark-mode label.text-muted,
  body.dark-mode small.text-muted,
  body.dark-mode small {
    color: #ffffff !important; /* White for dark mode */
    opacity: 1 !important;
  }
  
  /* Card header text */
  .card-header,
  .card-header * {
    color: #212529 !important; /* Black for light mode */
  }
  
  html[data-theme="dark"] .card-header,
  html[data-theme="dark"] .card-header *,
  body.dark-mode .card-header,
  body.dark-mode .card-header * {
    color: #ffffff !important; /* White for dark mode */
  }
  
  .form-control,
  .form-select,
  select.form-control,
  select.form-select,
  textarea.form-control {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    color: #212529 !important; /* Black for light mode */
    border-color: var(--nbx-color-border-input, #ced4da) !important;
  }
  
  html[data-theme="dark"] .form-control,
  html[data-theme="dark"] .form-select,
  html[data-theme="dark"] select.form-control,
  html[data-theme="dark"] select.form-select,
  html[data-theme="dark"] textarea.form-control,
  body.dark-mode .form-control,
  body.dark-mode .form-select,
  body.dark-mode select.form-control,
  body.dark-mode select.form-select,
  body.dark-mode textarea.form-control {
    background-color: var(--nbx-color-bg-input, #2a2a2a) !important;
    color: #ffffff !important; /* White for dark mode */
  }
  
  .form-control::placeholder {
    color: #212529 !important; /* Black for light mode */
    opacity: 0.7;
  }
  
  html[data-theme="dark"] .form-control::placeholder,
  body.dark-mode .form-control::placeholder {
    color: #ffffff !important; /* White for dark mode */
    opacity: 0.7;
  }
  
  .form-control:focus,
  .form-select:focus,
  select.form-control:focus,
  select.form-select:focus,
  textarea.form-control:focus {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    color: #212529 !important; /* Black for light mode */
    border-color: var(--nbx-color-border-input-focus, #86b7fe) !important;
  }
  
  html[data-theme="dark"] .form-control:focus,
  html[data-theme="dark"] .form-select:focus,
  html[data-theme="dark"] select.form-control:focus,
  html[data-theme="dark"] select.form-select:focus,
  html[data-theme="dark"] textarea.form-control:focus,
  body.dark-mode .form-control:focus,
  body.dark-mode .form-select:focus,
  body.dark-mode select.form-control:focus,
  body.dark-mode select.form-select:focus,
  body.dark-mode textarea.form-control:focus {
    background-color: var(--nbx-color-bg-input, #2a2a2a) !important;
    color: #ffffff !important; /* White for dark mode */
  }
  
  /* Checkbox and radio button styling for dark mode */
  .form-check-input {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    border-color: var(--nbx-color-border-input, #ced4da) !important;
  }
  
  html[data-theme="dark"] .form-check-input,
  body.dark-mode .form-check-input {
    background-color: var(--nbx-color-bg-input, #2a2a2a) !important;
  }
  
  .form-check-input:checked {
    background-color: var(--nbx-color-primary, #0d6efd) !important;
    border-color: var(--nbx-color-primary, #0d6efd) !important;
  }
  
  .form-check-input:focus {
    border-color: var(--nbx-color-border-input-focus, #86b7fe) !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }
  
  /* Datalist dropdown styling */
  datalist option {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    color: #212529 !important; /* Black for light mode */
  }
  
  html[data-theme="dark"] datalist option,
  body.dark-mode datalist option {
    background-color: var(--nbx-color-bg-input, #2a2a2a) !important;
    color: #ffffff !important;
  }
  
  /* Select dropdown options */
  select option {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    color: #212529 !important; /* Black for light mode */
  }
  
  html[data-theme="dark"] select option,
  body.dark-mode select option {
    background-color: var(--nbx-color-bg-input, #2a2a2a) !important;
    color: #ffffff !important;
  }
  
  #interfaces-checkbox-container {
    background-color: var(--nbx-color-bg-secondary, #f8f9fa) !important;
    border-color: var(--nbx-color-border-default, #dee2e6) !important;
    color: #212529 !important; /* Black for light mode */
  }
  
  html[data-theme="dark"] #interfaces-checkbox-container,
  body.dark-mode #interfaces-checkbox-container {
    background-color: var(--nbx-color-bg-secondary, #2a2a2a) !important;
    color: #ffffff !important;
  }
  
  /* Ensure all text inside the interfaces container is visible */
  #interfaces-checkbox-container,
  #interfaces-checkbox-container * {
    color: #212529 !important; /* Black for light mode */
  }
  
  html[data-theme="dark"] #interfaces-checkbox-container,
  html[data-theme="dark"] #interfaces-checkbox-container *,
  body.dark-mode #interfaces-checkbox-container,
  body.dark-mode #interfaces-checkbox-container * {
    color: #ffffff !important; /* White for dark mode */
  }
  
  /* Exception for muted text inside container - NO GREY, fully visible */
  #interfaces-checkbox-container .text-muted,
  #interfaces-checkbox-container p.text-muted {
    color: #212529 !important; /* Black for light mode */
    opacity: 1 !important;
  }
  
  html[data-theme="dark"] #interfaces-checkbox-container .text-muted,
  html[data-theme="dark"] #interfaces-checkbox-container p.text-muted,
  body.dark-mode #interfaces-checkbox-container .text-muted,
  body.dark-mode #interfaces-checkbox-container p.text-muted {
    color: #ffffff !important; /* White for dark mode */
  }
  
  /* Label for "Available Interfaces" section - NO GREY, fully visible */
  label.form-label.text-muted.small {
    color: #212529 !important; /* Black for light mode */
    opacity: 1 !important;
  }
  
  html[data-theme="dark"] label.form-label.text-muted.small,
  body.dark-mode label.form-label.text-muted.small {
    color: #ffffff !important; /* White for dark mode */
  }
  
  .form-check-label {
    color: var(--nbx-color-fg-default, #212529) !important;
  }
  
  /* Ensure form-check elements inside container are visible */
  #interfaces-checkbox-container .form-check {
    color: var(--nbx-color-fg-default, #212529) !important;
  }
  
  #interfaces-checkbox-container .form-check-label {
    color: var(--nbx-color-fg-default, #212529) !important;
  }
  
  #interfaces-checkbox-container .form-check-input {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    border-color: var(--nbx-color-border-input, #ced4da) !important;
  }
  
  #interfaces-checkbox-container .form-check-input:checked {
    background-color: var(--nbx-color-primary, #0d6efd) !important;
    border-color: var(--nbx-color-primary, #0d6efd) !important;
  }
  
  .invalid-feedback {
    color: var(--nbx-color-danger, #dc3545) !important;
  }
  
  .alert-danger {
    background-color: var(--nbx-color-bg-danger-subtle, #f8d7da) !important;
    color: var(--nbx-color-fg-danger, #721c24) !important;
    border-color: var(--nbx-color-border-danger, #f5c2c7) !important;
  }
  
  html[data-theme="dark"] .alert-danger,
  body.dark-mode .alert-danger {
    background-color: #5a1a1a !important; /* Dark red background */
    color: #ffffff !important; /* White text */
    border-color: #8b2635 !important;
  }
  
  /* Select2 styling for dark mode */
  .select2-container--default .select2-selection--multiple,
  .select2-container--default .select2-selection--single {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    color: #212529 !important; /* Black for light mode */
    border-color: var(--nbx-color-border-input, #ced4da) !important;
  }
  
  html[data-theme="dark"] .select2-container--default .select2-selection--multiple,
  html[data-theme="dark"] .select2-container--default .select2-selection--single,
  body.dark-mode .select2-container--default .select2-selection--multiple,
  body.dark-mode .select2-container--default .select2-selection--single {
    background-color: var(--nbx-color-bg-input, #2a2a2a) !important;
    color: #ffffff !important; /* White for dark mode */
    border-color: var(--nbx-color-border-input, #495057) !important;
  }
  
  .select2-container--default .select2-selection--multiple .select2-selection__rendered {
    color: #212529 !important; /* Black for light mode */
  }
  
  html[data-theme="dark"] .select2-container--default .select2-selection--multiple .select2-selection__rendered,
  body.dark-mode .select2-container--default .select2-selection--multiple .select2-selection__rendered {
    color: #ffffff !important; /* White for dark mode */
  }
  
  .select2-container--default .select2-selection__choice {
    background-color: var(--nbx-color-bg-secondary, #e9ecef) !important;
    color: #212529 !important; /* Black for light mode */
    border-color: var(--nbx-color-border-default, #ced4da) !important;
  }
  
  html[data-theme="dark"] .select2-container--default .select2-selection__choice,
  body.dark-mode .select2-container--default .select2-selection__choice {
    background-color: var(--nbx-color-bg-secondary, #495057) !important;
    color: #ffffff !important; /* White for dark mode */
    border-color: var(--nbx-color-border-default, #6c757d) !important;
  }
  
  .select2-container--default .select2-selection__choice__remove {
    color: #212529 !important; /* Black for light mode */
  }
  
  html[data-theme="dark"] .select2-container--default .select2-selection__choice__remove,
  body.dark-mode .select2-container--default .select2-selection__choice__remove {
    color: #ffffff !important; /* White for dark mode */
  }
  
  .select2-dropdown {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    border-color: var(--nbx-color-border-input, #ced4da) !important;
  }
  
  html[data-theme="dark"] .select2-dropdown,
  body.dark-mode .select2-dropdown {
    background-color: var(--nbx-color-bg-input, #2a2a2a) !important;
    border-color: var(--nbx-color-border-input, #495057) !important;
  }
  
  .select2-results__option {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    color: #212529 !important; /* Black for light mode */
  }
  
  html[data-theme="dark"] .select2-results__option,
  body.dark-mode .select2-results__option {
    background-color: var(--nbx-color-bg-input, #2a2a2a) !important;
    color: #ffffff !important; /* White for dark mode */
  }
  
  .select2-results__option--highlighted {
    background-color: var(--nbx-color-primary, #0d6efd) !important;
    color: #ffffff !important;
  }
  
  .select2-search__field {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    color: #212529 !important; /* Black for light mode */
  }
  
  html[data-theme="dark"] .select2-search__field,
  body.dark-mode .select2-search__field {
    background-color: var(--nbx-color-bg-input, #2a2a2a) !important;
    color: #212529 !important; /* Dark text for dark mode - user needs to see what they type */
  }
  
  .select2-search__field::placeholder {
    color: #212529 !important; /* Black for light mode */
    opacity: 0.7;
  }
  
  html[data-theme="dark"] .select2-search__field::placeholder,
  body.dark-mode .select2-search__field::placeholder {
    color: #ffffff !important; /* White for dark mode */
    opacity: 0.7;
  }
  
  /* Loading overlay - dark mode compatible */
  #loading-overlay {
    background: rgba(0, 0, 0, 0.7) !important;
  }
  
  #loading-overlay > div {
    background: var(--nbx-color-bg-default, #fff) !important;
    color: #212529 !important; /* Black for light mode */
  }
  
  html[data-theme="dark"] #loading-overlay > div,
  body.dark-mode #loading-overlay > div {
    background: var(--nbx-color-bg-default, #2a2a2a) !important;
    color: #ffffff !important;
  }
  
  #loading-overlay h4 {
    color: #212529 !important; /* Black for light mode */
  }
  
  html[data-theme="dark"] #loading-overlay h4,
  body.dark-mode #loading-overlay h4 {
    color: #ffffff !important; /* White for dark mode */
  }
  
  #loading-overlay .text-muted {
    color: #212529 !important; /* Black for light mode */
  }
  
  html[data-theme="dark"] #loading-overlay .text-muted,
  body.dark-mode #loading-overlay .text-muted {
    color: #ffffff !important; /* White for dark mode */
  }
  
  /* Disabled button styling - NO GREY text */
  #deploy-btn:disabled {
    background-color: var(--nbx-color-bg-tertiary, #6c757d) !important;
    border-color: var(--nbx-color-bg-tertiary, #6c757d) !important;
    color: #212529 !important; /* Black for light mode */
    opacity: 0.6;
    cursor: not-allowed !important;
  }
  
  html[data-theme="dark"] #deploy-btn:disabled,
  body.dark-mode #deploy-btn:disabled {
    color: #ffffff !important; /* White for dark mode */
  }
</style>
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">{% trans "VLAN Deployment" %}</h5>
        </div>
        <div class="card-body">
          <p class="text-muted" style="color: var(--nbx-color-fg-default) !important;">
            {% trans "Deploy VLAN configurations to network devices and update NetBox interface assignments. Phase 1: Access mode (untagged) only." %}
          </p>

          {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
              {{ form.non_field_errors }}
            </div>
          {% endif %}

          <!-- Loading overlay -->
          <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center;">
            <div style="background: var(--nbx-color-bg-default); padding: 30px; border-radius: 8px; text-align: center; max-width: 400px; color: var(--nbx-color-fg-default);">
              <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
              </div>
              <h4 style="color: var(--nbx-color-fg-default);">Deploying VLAN Configuration...</h4>
              <p class="text-muted mb-0" style="color: var(--nbx-color-fg-default) !important; opacity: 1 !important;">Applying configuration to devices. This may take a minute.</p>
            </div>
          </div>

          <form method="post" id="vlan-deployment-form">
            {% csrf_token %}

            {# Deployment Scope - Always visible #}
            <div class="mb-3">
              <label class="form-label">{{ form.deployment_scope.label }}</label>
              <div class="form-text" style="color: var(--nbx-color-fg-default) !important;">{{ form.deployment_scope.help_text }}</div>
              {% for radio in form.deployment_scope %}
                <div class="form-check">
                  {{ radio.tag }}
                  <label class="form-check-label" for="{{ radio.id_for_label }}">
                    {{ radio.choice_label }}
                  </label>
                </div>
              {% endfor %}
              {% if form.deployment_scope.errors %}
                <div class="invalid-feedback d-block">{{ form.deployment_scope.errors }}</div>
              {% endif %}
            </div>

            {# Single Device Mode Fields #}
            <div id="single-device-fields">
              <div class="mb-3">
                <label for="{{ form.devices.id_for_label }}" class="form-label required">{{ form.devices.label }}</label>
                {{ form.devices }}
                <div class="form-text" style="color: var(--nbx-color-fg-default) !important;">{{ form.devices.help_text }}</div>
                {% if form.devices.errors %}
                  <div class="invalid-feedback d-block">{{ form.devices.errors }}</div>
                {% endif %}
              </div>
            </div>

            {# Device Group Mode Fields #}
            <div id="group-device-fields" style="display: none;">
              <div class="mb-3">
                <label for="{{ form.site.id_for_label }}" class="form-label required">{{ form.site.label }}</label>
                {{ form.site }}
                <div class="form-text" style="color: var(--nbx-color-fg-default) !important;">{{ form.site.help_text }}</div>
                {% if form.site.errors %}
                  <div class="invalid-feedback d-block">{{ form.site.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="{{ form.location.id_for_label }}" class="form-label required">{{ form.location.label }}</label>
                {{ form.location }}
                <div class="form-text" style="color: var(--nbx-color-fg-default) !important;">{{ form.location.help_text }}</div>
                {% if form.location.errors %}
                  <div class="invalid-feedback d-block">{{ form.location.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="{{ form.manufacturer.id_for_label }}" class="form-label required">{{ form.manufacturer.label }}</label>
                {{ form.manufacturer }}
                <div class="form-text" style="color: var(--nbx-color-fg-default) !important;">{{ form.manufacturer.help_text }}</div>
                {% if form.manufacturer.errors %}
                  <div class="invalid-feedback d-block">{{ form.manufacturer.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="{{ form.role.id_for_label }}" class="form-label required">{{ form.role.label }}</label>
                {{ form.role }}
                <div class="form-text" style="color: var(--nbx-color-fg-default) !important;">{{ form.role.help_text }}</div>
                {% if form.role.errors %}
                  <div class="invalid-feedback d-block">{{ form.role.errors }}</div>
                {% endif %}
              </div>

              {# Excluded Devices - Only available in Group mode #}
              <div class="mb-3">
                <label for="{{ form.excluded_devices.id_for_label }}" class="form-label">{{ form.excluded_devices.label }}</label>
                {{ form.excluded_devices }}
                <div class="form-text" style="color: var(--nbx-color-fg-default) !important;">{{ form.excluded_devices.help_text }}</div>
                {% if form.excluded_devices.errors %}
                  <div class="invalid-feedback d-block">{{ form.excluded_devices.errors }}</div>
                {% endif %}
              </div>
            </div>

            {# Interface Selection - Two fields: Checkboxes + Manual Entry #}
            <div class="mb-3">
              <label class="form-label required">Interfaces</label>

              {# Field 1: Checkbox list for available interfaces #}
              <div class="mb-2">
                <label class="form-label text-muted small" style="color: var(--nbx-color-fg-default) !important; opacity: 1 !important;">Available Interfaces (select from device)</label>
                <div id="interfaces-checkbox-container" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--nbx-color-border-default); padding: 10px; border-radius: 4px; background-color: var(--nbx-color-bg-secondary); color: var(--nbx-color-fg-default);">
                  <p class="text-muted mb-0" style="color: var(--nbx-color-fg-default) !important; opacity: 1 !important;">Select devices first to load interfaces</p>
                </div>
              </div>

              {# Field 2: Manual text input for custom interfaces #}
              <div class="mb-2">
                <label for="id_interfaces_manual" class="form-label text-muted small">Additional Interfaces (manual entry)</label>
                <textarea
                  id="id_interfaces_manual"
                  name="interfaces_manual"
                  class="form-control"
                  rows="2"
                  placeholder="Optional: Add custom interfaces (e.g., swp100, swp200 or swp1-48)"
                >{{ form.interfaces_manual.value|default:'' }}</textarea>
                <div class="form-text" style="color: var(--nbx-color-fg-default) !important;">
                  Enter additional interface names separated by commas or use ranges (e.g., swp1-48, Ethernet1-24).
                </div>
              </div>

              <div class="form-text" style="color: var(--nbx-color-fg-default) !important;">
                <strong>Combined selection:</strong> Both checkbox selections and manual entries will be combined and validated against NetBox.
              </div>

              {% if form.interfaces_select.errors %}
                <div class="invalid-feedback d-block">{{ form.interfaces_select.errors }}</div>
              {% endif %}
              {% if form.interfaces_manual.errors %}
                <div class="invalid-feedback d-block">{{ form.interfaces_manual.errors }}</div>
              {% endif %}
            </div>

            {# VLAN ID - Text input with autocomplete dropdown #}
            <div class="mb-3">
              <label for="id_vlan_id" class="form-label required">{{ form.vlan_id.label }}</label>
              <div style="position: relative; max-width: 500px;">
                <input
                  type="text"
                  id="id_vlan_id"
                  name="vlan_id"
                  class="form-control"
                  list="vlan_datalist"
                  placeholder="Type VLAN ID (e.g., 100) or click to see dropdown"
                  min="1"
                  max="4094"
                  required
                  value="{{ form.vlan_id.value|default:'' }}"
                  autocomplete="off"
                />
                <datalist id="vlan_datalist">
                  <!-- Will be populated dynamically with VLANs from device's location -->
                </datalist>
              </div>
              <div class="form-text" style="color: var(--nbx-color-fg-default) !important;">Click on the input field above to see available VLANs in the dropdown menu.</div>
              
              {% if form.vlan_id.errors %}
                <div class="invalid-feedback d-block">{{ form.vlan_id.errors }}</div>
              {% endif %}
            </div>

            {# Deployment Options - Mutually exclusive #}
            <div class="mb-3">
              <label class="form-label">Deployment Mode</label>

              <div class="form-check">
                {{ form.dry_run }}
                <label class="form-check-label" for="{{ form.dry_run.id_for_label }}">
                  {{ form.dry_run.label }}
                </label>
                <div class="form-text" style="color: var(--nbx-color-fg-default) !important;">{{ form.dry_run.help_text }}</div>
              </div>

              <div class="form-check mt-2">
                {{ form.deploy_changes }}
                <label class="form-check-label" for="{{ form.deploy_changes.id_for_label }}">
                  {{ form.deploy_changes.label }}
                </label>
                <div class="form-text" style="color: var(--nbx-color-fg-default) !important;">{{ form.deploy_changes.help_text }}</div>
              </div>
            </div>

            <div class="mt-3">
              <button type="submit" class="btn btn-primary" id="deploy-btn" name="deploy" value="1">
                <i class="mdi mdi-upload-network"></i>
                <span id="deploy-btn-text">{% trans "Deploy VLAN" %}</span>
              </button>
            </div>
          </form>

          <script>
            // NetBox Theme Detection and Color Application
            function getNetBoxTheme() {
              try {
        return localStorage.getItem('netbox-color-mode') || 'light';
      } catch (e) {
        // Fallback: check if NetBox has set data-theme attribute
        const htmlEl = document.documentElement;
        if (htmlEl && htmlEl.getAttribute('data-theme') === 'dark') {
          return 'dark';
        }
        if (document.body && document.body.classList.contains('dark-mode')) {
          return 'dark';
        }
        return 'light';
      }
            }
            
            function isDarkMode() {
              return getNetBoxTheme() === 'dark';
            }
            
            function applyThemeColors() {
              const darkMode = isDarkMode();
              const textColor = darkMode ? '#ffffff' : '#212529';
              const bgColor = darkMode ? '#2a2a2a' : '#f8f9fa';
              
              // Apply to all text elements in card-body
              document.querySelectorAll('.card-body p, .card-body label, .card-body span, .card-body small, .card-body div, .card-body .form-text, .card-body .text-muted').forEach(el => {
                el.style.setProperty('color', textColor, 'important');
                if (el.classList.contains('text-muted') || el.classList.contains('form-text')) {
                  el.style.setProperty('opacity', '1', 'important');
                }
              });
              
              // Apply to card header
              document.querySelectorAll('.card-header, .card-header *').forEach(el => {
                el.style.setProperty('color', textColor, 'important');
              });
              
              // Apply to specific containers
              const containers = document.querySelectorAll('#interfaces-checkbox-container, .deployment-logs div, #loading-overlay > div');
              containers.forEach(container => {
                container.style.setProperty('background-color', darkMode ? '#2a2a2a' : bgColor, 'important');
                container.style.setProperty('color', textColor, 'important');
              });
              
              // Apply to form text elements
              document.querySelectorAll('.form-text, .text-muted, small').forEach(el => {
                el.style.setProperty('color', textColor, 'important');
                el.style.setProperty('opacity', '1', 'important');
              });
            }
            
            // Apply Select2 dark mode styles to dynamically created elements
            function applySelect2DarkMode() {
              const darkMode = isDarkMode();
              const textColor = darkMode ? '#ffffff' : '#212529';
              const bgColor = darkMode ? '#2a2a2a' : '#fff';
              const borderColor = darkMode ? '#495057' : '#ced4da';
              const choiceBg = darkMode ? '#495057' : '#e9ecef';
              
              // Apply to all Select2 elements
              document.querySelectorAll('.select2-container--default .select2-selection--multiple, .select2-container--default .select2-selection--single').forEach(el => {
                el.style.setProperty('background-color', bgColor, 'important');
                el.style.setProperty('color', textColor, 'important');
                el.style.setProperty('border-color', borderColor, 'important');
              });
              
              document.querySelectorAll('.select2-container--default .select2-selection__rendered').forEach(el => {
                el.style.setProperty('color', textColor, 'important');
              });
              
              document.querySelectorAll('.select2-container--default .select2-selection__choice').forEach(el => {
                el.style.setProperty('background-color', choiceBg, 'important');
                el.style.setProperty('color', textColor, 'important');
                el.style.setProperty('border-color', borderColor, 'important');
              });
              
              document.querySelectorAll('.select2-container--default .select2-selection__choice__remove').forEach(el => {
                el.style.setProperty('color', textColor, 'important');
              });
              
              document.querySelectorAll('.select2-dropdown').forEach(el => {
                el.style.setProperty('background-color', bgColor, 'important');
                el.style.setProperty('border-color', borderColor, 'important');
              });
              
              document.querySelectorAll('.select2-results__option').forEach(el => {
                el.style.setProperty('background-color', bgColor, 'important');
                el.style.setProperty('color', textColor, 'important');
              });
              
              document.querySelectorAll('.select2-search__field').forEach(el => {
                el.style.setProperty('background-color', bgColor, 'important');
                // Use dark text so user can see what they're typing (even in dark mode)
                el.style.setProperty('color', '#212529', 'important');
              });
            }
            
            // Apply on page load
            document.addEventListener('DOMContentLoaded', function() {
              applyThemeColors();
              // Wait for Select2 to initialize, then apply styles
              setTimeout(applySelect2DarkMode, 500);
              
              // Listen for NetBox theme changes
              window.addEventListener('netbox.colorModeChanged', function(e) {
                setTimeout(function() {
                  applyThemeColors();
                  applySelect2DarkMode();
                }, 100);
              });
              
              // Also check periodically in case theme changes
              setInterval(function() {
                applyThemeColors();
                applySelect2DarkMode();
              }, 2000);
              
              // Use MutationObserver to watch for dynamically added Select2 elements
              const observer = new MutationObserver(function(mutations) {
                applySelect2DarkMode();
              });
              
              observer.observe(document.body, {
                childList: true,
                subtree: true
              });
            });
            
            // Make function available globally for dynamic elements
            window.getNetBoxTextColor = function() {
              return isDarkMode() ? '#ffffff' : '#212529';
            };
            
            // Show/hide fields based on deployment scope
            function updateFieldVisibility() {
              const scope = document.querySelector('input[name="deployment_scope"]:checked').value;

              const singleFields = document.getElementById('single-device-fields');
              const groupFields = document.getElementById('group-device-fields');

              if (scope === 'single') {
                singleFields.style.display = 'block';
                groupFields.style.display = 'none';
              } else {
                singleFields.style.display = 'none';
                groupFields.style.display = 'block';
              }
            }

            // Helper function to render interface checkboxes
            function renderInterfaceCheckboxes(interfaces, container) {
              container.innerHTML = '';
              
              if (interfaces.length === 0) {
                const p = document.createElement('p');
                p.className = 'text-muted mb-0';
                p.style.color = window.getNetBoxTextColor ? window.getNetBoxTextColor() : (isDarkMode() ? '#ffffff' : '#212529');
                p.style.opacity = '1';
                p.textContent = 'No common interfaces found';
                container.appendChild(p);
                return;
              }
              
              // Create checkboxes for each interface
              interfaces.forEach(iface => {
                const div = document.createElement('div');
                div.className = 'form-check';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input';
                checkbox.name = 'interfaces_select';
                checkbox.value = iface;
                checkbox.id = `interface_${iface}`;

                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.style.color = window.getNetBoxTextColor ? window.getNetBoxTextColor() : (isDarkMode() ? '#ffffff' : '#212529');
                label.htmlFor = `interface_${iface}`;
                label.textContent = iface;

                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
              });
            }

            // Load interfaces and populate checkboxes when devices are selected (Single mode)
            function loadCommonInterfaces() {
              console.log('loadCommonInterfaces called');
              const devicesSelect = document.getElementById('id_devices');
              const interfacesContainer = document.getElementById('interfaces-checkbox-container');
              const selectedDeviceIds = Array.from(devicesSelect.selectedOptions).map(opt => opt.value);

              console.log('Selected device IDs:', selectedDeviceIds);

              if (selectedDeviceIds.length === 0) {
                const p = document.createElement('p');
                p.className = 'text-muted mb-0';
                p.style.color = window.getNetBoxTextColor ? window.getNetBoxTextColor() : (isDarkMode() ? '#ffffff' : '#212529');
                p.style.opacity = '1';
                p.textContent = 'Select devices first to load interfaces';
                interfacesContainer.innerHTML = '';
                interfacesContainer.appendChild(p);
                return;
              }

              // Show loading
              const loadingP = document.createElement('p');
              loadingP.className = 'text-muted mb-0';
              loadingP.style.color = window.getNetBoxTextColor ? window.getNetBoxTextColor() : (isDarkMode() ? '#ffffff' : '#212529');
              loadingP.style.opacity = '1';
              loadingP.textContent = 'Loading interfaces...';
              interfacesContainer.innerHTML = '';
              interfacesContainer.appendChild(loadingP);

              // Build query string
              const params = new URLSearchParams();
              selectedDeviceIds.forEach(id => params.append('device_ids[]', id));

              const url = `/plugins/automation/vlan-deployment/get-interfaces/?${params.toString()}`;
              console.log('Fetching interfaces from:', url);

              // Fetch common interfaces
              fetch(url)
                .then(response => {
                  console.log('Interface response status:', response.status);
                  return response.json();
                })
                .then(data => {
                  console.log('Interface data received:', data);
                  
                  // Use helper function to render checkboxes
                  renderInterfaceCheckboxes(data.interfaces, interfacesContainer);

                  // Also filter VLANs by site of selected devices
                  console.log('About to call filterVLANsByDevices with:', selectedDeviceIds);
                  filterVLANsByDevices(selectedDeviceIds);
                })
                .catch(error => {
                  console.error('Error loading interfaces:', error);
                  const errorP = document.createElement('p');
                  errorP.className = 'text-danger mb-0';
                  errorP.style.color = 'var(--nbx-color-danger, #dc3545)';
                  errorP.textContent = 'Error loading interfaces';
                  interfacesContainer.innerHTML = '';
                  interfacesContainer.appendChild(errorP);
                });
            }

            // Load interfaces for Group mode (Site + Location + Manufacturer + Role)
            function loadInterfacesFromGroupFilters() {
              console.log('loadInterfacesFromGroupFilters called');
              
              const siteSelect = document.getElementById('id_site');
              const locationSelect = document.getElementById('id_location');
              const manufacturerSelect = document.getElementById('id_manufacturer');
              const roleSelect = document.getElementById('id_role');
              const interfacesContainer = document.getElementById('interfaces-checkbox-container');
              
              const siteId = siteSelect ? siteSelect.value : '';
              const locationId = locationSelect ? locationSelect.value : '';
              const manufacturerId = manufacturerSelect ? manufacturerSelect.value : '';
              const roleId = roleSelect ? roleSelect.value : '';
              
              console.log('Group filters:', {siteId, locationId, manufacturerId, roleId});
              
              // Only load interfaces if ALL filters are selected
              if (!siteId || !locationId || !manufacturerId || !roleId) {
                const p = document.createElement('p');
                p.className = 'text-muted mb-0';
                p.style.color = window.getNetBoxTextColor ? window.getNetBoxTextColor() : (isDarkMode() ? '#ffffff' : '#212529');
                p.style.opacity = '1';
                p.textContent = 'Select all filters (Site, Location, Manufacturer, Role) to load interfaces';
                interfacesContainer.innerHTML = '';
                interfacesContainer.appendChild(p);
                return;
              }
              
              // Show loading
              const loadingP = document.createElement('p');
              loadingP.className = 'text-muted mb-0';
              loadingP.style.color = window.getNetBoxTextColor ? window.getNetBoxTextColor() : (isDarkMode() ? '#ffffff' : '#212529');
              loadingP.style.opacity = '1';
              loadingP.textContent = 'Loading interfaces...';
              interfacesContainer.innerHTML = '';
              interfacesContainer.appendChild(loadingP);
              
              // Build query string with filter parameters
              const url = `/plugins/automation/vlan-deployment/get-interfaces/?site_id=${siteId}&location_id=${locationId}&manufacturer_id=${manufacturerId}&role_id=${roleId}`;
              console.log('Fetching interfaces from:', url);
              
              // Fetch common interfaces for devices matching filters
              fetch(url)
                .then(response => {
                  console.log('Interface response status:', response.status);
                  return response.json();
                })
                .then(data => {
                  console.log('Interface data received:', data);
                  console.log(`Found ${data.device_count} devices with common interfaces`);
                  
                  // Use helper function to render checkboxes
                  renderInterfaceCheckboxes(data.interfaces, interfacesContainer);
                  
                  // Also load VLANs for this site
                  filterVLANsBySite();
                })
                .catch(error => {
                  console.error('Error loading interfaces:', error);
                  const errorP = document.createElement('p');
                  errorP.className = 'text-danger mb-0';
                  errorP.style.color = 'var(--nbx-color-danger, #dc3545)';
                  errorP.textContent = 'Error loading interfaces';
                  interfacesContainer.innerHTML = '';
                  interfacesContainer.appendChild(errorP);
                });
            }

            // Filter VLANs by site when devices are selected (single mode)
            function filterVLANsByDevices(deviceIds) {
              console.log('filterVLANsByDevices called with:', deviceIds);

              const datalist = document.getElementById('vlan_datalist');

              if (deviceIds.length === 0) {
                // Reset VLAN datalist
                datalist.innerHTML = '';
                return;
              }

              // Build query string with device IDs
              const params = new URLSearchParams();
              deviceIds.forEach(id => params.append('device_ids[]', id));

              const url = `/plugins/automation/vlan-deployment/get-vlans/?${params.toString()}`;
              console.log('Fetching VLANs from:', url);

              // Fetch VLANs for the site of selected devices
              fetch(url)
                .then(response => {
                  console.log('VLAN response status:', response.status);
                  return response.json();
                })
                .then(data => {
                  console.log('VLAN data received:', data);

                  // Populate datalist with VLAN suggestions (for dropdown)
                  datalist.innerHTML = ''; // Clear existing options

                  if (data.vlans && data.vlans.length > 0) {
                    data.vlans.forEach(vlan => {
                      const option = document.createElement('option');
                      option.value = vlan.vid;
                      option.textContent = vlan.name ? `${vlan.vid} - ${vlan.name}` : vlan.vid;
                      datalist.appendChild(option);
                    });
                    console.log(`Populated datalist dropdown with ${data.vlans.length} VLANs from device location`);
                  } else {
                    console.log('No VLANs found for this location, user can still type custom VLAN ID');
                  }
                })
                .catch(error => {
                  console.error('Error loading VLANs:', error);
                });
            }

            // Filter VLANs by site when site is selected (group mode)
            function filterVLANsBySite() {
              const siteSelect = document.getElementById('id_site');
              const siteId = siteSelect.value;
              
              const datalist = document.getElementById('vlan_datalist');

              if (!siteId) {
                // Clear datalist if no site selected
                datalist.innerHTML = '';
                return;
              }

              // Fetch VLANs for this site
              fetch(`/plugins/automation/vlan-deployment/get-vlans/?site_id=${siteId}`)
                .then(response => response.json())
                .then(data => {
                  // Populate datalist with VLAN suggestions (for dropdown)
                  datalist.innerHTML = ''; // Clear existing options

                  if (data.vlans && data.vlans.length > 0) {
                    data.vlans.forEach(vlan => {
                      const option = document.createElement('option');
                      option.value = vlan.vid;
                      option.textContent = vlan.name ? `${vlan.vid} - ${vlan.name}` : vlan.vid;
                      datalist.appendChild(option);
                    });
                    console.log(`Populated datalist dropdown with ${data.vlans.length} VLANs from site`);
                  } else {
                    console.log('No VLANs found for this site, user can still type custom VLAN ID');
                  }
                })
                .catch(error => {
                  console.error('Error loading VLANs:', error);
                });
            }

            // Update deploy button state (enabled/disabled and text)
            function updateDeployButtonState() {
              const dryRunCheckbox = document.getElementById('id_dry_run');
              const deployCheckbox = document.getElementById('id_deploy_changes');
              const deployBtn = document.getElementById('deploy-btn');
              const deployBtnText = document.getElementById('deploy-btn-text');

              if (dryRunCheckbox && deployCheckbox && deployBtn && deployBtnText) {
                const isAnySelected = dryRunCheckbox.checked || deployCheckbox.checked;
                
                // Enable/disable button based on selection
                deployBtn.disabled = !isAnySelected;
                
                // Update button text
                if (dryRunCheckbox.checked) {
                  deployBtnText.textContent = 'Deploy VLAN Dryrun';
                } else if (deployCheckbox.checked) {
                  deployBtnText.textContent = 'Deploy VLAN';
                } else {
                  deployBtnText.textContent = 'Deploy VLAN';
                }
              }
            }
            
            // Update deploy button text based on selected mode (legacy function name for compatibility)
            function updateDeployButtonText() {
              updateDeployButtonState();
            }

            // Make Dry Run and Deploy Changes mutually exclusive
            function setupMutuallyExclusiveCheckboxes() {
              const dryRunCheckbox = document.getElementById('id_dry_run');
              const deployCheckbox = document.getElementById('id_deploy_changes');

              if (dryRunCheckbox && deployCheckbox) {
                // Handler for dry run checkbox changes
                const handleDryRunChange = function() {
                  if (this.checked) {
                    deployCheckbox.checked = false;
                    deployCheckbox.disabled = true;
                    deployCheckbox.parentElement.style.opacity = '0.5';
                  } else {
                    deployCheckbox.disabled = false;
                    deployCheckbox.parentElement.style.opacity = '1';
                  }
                  updateDeployButtonState();
                };
                
                // Handler for deploy changes checkbox changes
                const handleDeployChange = function() {
                  if (this.checked) {
                    dryRunCheckbox.checked = false;
                    dryRunCheckbox.disabled = true;
                    dryRunCheckbox.parentElement.style.opacity = '0.5';
                  } else {
                    dryRunCheckbox.disabled = false;
                    dryRunCheckbox.parentElement.style.opacity = '1';
                  }
                  updateDeployButtonState();
                };
                
                dryRunCheckbox.addEventListener('change', handleDryRunChange);
                deployCheckbox.addEventListener('change', handleDeployChange);

                // Initialize state on page load
                if (dryRunCheckbox.checked) {
                  deployCheckbox.disabled = true;
                  deployCheckbox.parentElement.style.opacity = '0.5';
                } else if (deployCheckbox.checked) {
                  dryRunCheckbox.disabled = true;
                  dryRunCheckbox.parentElement.style.opacity = '0.5';
                }
                
                // Update button state on page load
                updateDeployButtonState();
              }
            }

            // Initialize on page load
            document.addEventListener('DOMContentLoaded', function() {
              updateFieldVisibility();
              setupMutuallyExclusiveCheckboxes();

              // Listen for scope changes
              document.querySelectorAll('input[name="deployment_scope"]').forEach(radio => {
                radio.addEventListener('change', updateFieldVisibility);
              });

              // Listen for device selection changes (single mode)
              const devicesSelect = document.getElementById('id_devices');
              if (devicesSelect) {
                devicesSelect.addEventListener('change', loadCommonInterfaces);

                // If devices are already selected (form re-render after error), load interfaces
                if (devicesSelect.selectedOptions.length > 0) {
                  console.log('Devices already selected on page load, loading interfaces...');
                  loadCommonInterfaces();
                }
              }

              // Listen for group filter changes (group mode - load interfaces)
              const siteSelect = document.getElementById('id_site');
              const locationSelect = document.getElementById('id_location');
              const manufacturerSelect = document.getElementById('id_manufacturer');
              const roleSelect = document.getElementById('id_role');
              
              if (siteSelect) {
                siteSelect.addEventListener('change', function() {
                  filterVLANsBySite();  // Load VLANs
                  loadInterfacesFromGroupFilters();  // Load interfaces
                });
              }
              
              if (locationSelect) {
                locationSelect.addEventListener('change', loadInterfacesFromGroupFilters);
              }
              
              if (manufacturerSelect) {
                manufacturerSelect.addEventListener('change', loadInterfacesFromGroupFilters);
              }
              
              if (roleSelect) {
                roleSelect.addEventListener('change', loadInterfacesFromGroupFilters);
              }
            });

            // Form submission handler
            document.getElementById('vlan-deployment-form').addEventListener('submit', function(e) {
              // Show loading overlay
              const overlay = document.getElementById('loading-overlay');
              overlay.style.display = 'flex';

              // Disable form button
              document.getElementById('deploy-btn').disabled = true;
            });
          </script>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

