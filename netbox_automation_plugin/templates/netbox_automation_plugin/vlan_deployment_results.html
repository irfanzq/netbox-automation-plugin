{% extends 'base/layout.html' %}
{% load i18n %}
{% load render_table from django_tables2 %}
{% load form_helpers %}

{% block title %}{% trans "VLAN Deployment Results" %}{% endblock %}

{% block content %}
<style>
  /* Dark mode compatible styles for VLAN Deployment Results */
  .device-summary-card {
    transition: all 0.2s ease;
    background-color: var(--nbx-color-bg-secondary, #343a40) !important;
    color: var(--nbx-color-fg-default, #ffffff) !important;
  }
  .device-summary-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transform: translateY(-2px);
  }
  .device-summary-card h6 {
    color: var(--nbx-color-fg-default, #ffffff) !important;
  }
  .device-summary-card h6 a {
    text-decoration: none;
    color: var(--nbx-color-fg-link, #ffffff) !important;
  }
  .device-summary-card h6 a:hover {
    text-decoration: underline;
    color: var(--nbx-color-fg-link-hover, #e0e0e0) !important;
  }
  .device-summary-card .badge {
    color: var(--nbx-color-fg-default, #ffffff) !important;
  }
  .device-summary-card .badge.bg-secondary {
    background-color: var(--nbx-color-bg-tertiary, #6c757d) !important;
    color: var(--nbx-color-fg-default, #ffffff) !important;
  }
  .device-summary-card .badge.bg-success {
    background-color: var(--nbx-color-success, #198754) !important;
    color: var(--nbx-color-fg-default, #ffffff) !important;
  }
  .device-summary-card .badge.bg-warning {
    background-color: var(--nbx-color-warning, #ffc107) !important;
    color: var(--nbx-color-fg-on-warning, #000000) !important;
  }
  .device-summary-card .badge.bg-danger {
    background-color: var(--nbx-color-danger, #dc3545) !important;
    color: var(--nbx-color-fg-default, #ffffff) !important;
  }
  .device-summary-card .small {
    color: var(--nbx-color-fg-default, #ffffff) !important;
  }
  
  /* Deployment logs - NO GREY: Black in light, White in dark */
  .deployment-logs {
    color: #212529 !important; /* Black for light mode */
  }
  
  @media (prefers-color-scheme: dark) {
    .deployment-logs {
      color: #ffffff !important; /* White for dark mode */
    }
  }
  
  .deployment-logs summary {
    color: var(--nbx-color-fg-link, #0066cc) !important;
  }
  
  .deployment-logs div {
    background-color: var(--nbx-color-bg-secondary, #f5f5f5) !important;
    color: #212529 !important; /* Black for light mode */
    border-left-color: var(--nbx-color-border-primary, #0066cc) !important;
  }
  
  @media (prefers-color-scheme: dark) {
    .deployment-logs div {
      background-color: #2a2a2a !important; /* Dark background in dark mode */
      color: #ffffff !important; /* White for dark mode */
    }
  }
  
  /* Ensure all text inside logs is visible */
  .deployment-logs div * {
    color: #212529 !important; /* Black for light mode */
  }
  
  @media (prefers-color-scheme: dark) {
    .deployment-logs div * {
      color: #ffffff !important; /* White for dark mode */
    }
  }
  
  /* Code/pre blocks inside logs */
  .deployment-logs div pre,
  .deployment-logs div code {
    background-color: var(--nbx-color-bg-tertiary, #e9ecef) !important;
    color: #212529 !important; /* Black for light mode */
  }
  
  @media (prefers-color-scheme: dark) {
    .deployment-logs div pre,
    .deployment-logs div code {
      background-color: #1a1a1a !important; /* Dark background in dark mode */
      color: #ffffff !important; /* White for dark mode */
    }
  }
  
  /* Filter buttons - dark mode compatible */
  .filter-btn {
    color: var(--nbx-color-fg-default, #212529) !important;
  }
  
  /* Table text - NO GREY: Black in light, White in dark */
  .table {
    color: #212529 !important; /* Black for light mode */
  }
  
  @media (prefers-color-scheme: dark) {
    .table {
      color: #ffffff !important; /* White for dark mode */
    }
  }
  
  .table td,
  .table th {
    color: #212529 !important; /* Black for light mode */
  }
  
  @media (prefers-color-scheme: dark) {
    .table td,
    .table th {
      color: #ffffff !important; /* White for dark mode */
    }
  }
  
  /* FORCE all text: WHITE in dark mode, BLACK in light mode - NO GREY! */
  
  /* Light mode: Black text */
  .card-body,
  .card-body *:not(input):not(select):not(textarea):not(button):not(.form-control):not(.form-select):not(.btn):not(.badge) {
    color: #212529 !important; /* Pure black for light mode */
  }
  
  /* Dark mode: White text */
  @media (prefers-color-scheme: dark) {
    .card-body,
    .card-body *:not(input):not(select):not(textarea):not(button):not(.form-control):not(.form-select):not(.btn):not(.badge) {
      color: #ffffff !important; /* Pure white for dark mode */
    }
  }
  
  /* Specific overrides for common text elements - Light mode */
  .card-body .form-label,
  .card-body label,
  .card-body p,
  .card-body div,
  .card-body span,
  .card-body small,
  .card-body h1,
  .card-body h2,
  .card-body h3,
  .card-body h4,
  .card-body h5,
  .card-body h6,
  .card-body .card-title,
  .card-body dt,
  .card-body dd {
    color: #212529 !important; /* Black for light mode */
  }
  
  @media (prefers-color-scheme: dark) {
    .card-body .form-label,
    .card-body label,
    .card-body p,
    .card-body div,
    .card-body span,
    .card-body small,
    .card-body h1,
    .card-body h2,
    .card-body h3,
    .card-body h4,
    .card-body h5,
    .card-body h6,
    .card-body .card-title,
    .card-body dt,
    .card-body dd {
      color: #ffffff !important; /* White for dark mode */
    }
  }
  
  /* Help text - NO GREY: Black in light, White in dark */
  .card-body .form-text,
  .card-body .text-muted,
  .card-body p.text-muted,
  .card-body label.text-muted,
  .card-body small.text-muted,
  .form-text,
  .text-muted,
  p.text-muted,
  label.text-muted,
  small.text-muted,
  small {
    color: #212529 !important; /* Black for light mode */
    opacity: 1 !important;
  }
  
  @media (prefers-color-scheme: dark) {
    .card-body .form-text,
    .card-body .text-muted,
    .card-body p.text-muted,
    .card-body label.text-muted,
    .card-body small.text-muted,
    .form-text,
    .text-muted,
    p.text-muted,
    label.text-muted,
    small.text-muted,
    small {
      color: #ffffff !important; /* White for dark mode */
      opacity: 1 !important;
    }
  }
  
  /* Card header text */
  .card-header,
  .card-header * {
    color: #212529 !important; /* Black for light mode */
  }
  
  @media (prefers-color-scheme: dark) {
    .card-header,
    .card-header * {
      color: #ffffff !important; /* White for dark mode */
    }
  }
</style>
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">{% trans "VLAN Deployment Summary" %}</h5>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-md-3">{% trans "Devices" %}</dt>
            <dd class="col-md-3">{{ summary.device_count }}</dd>

            <dt class="col-md-3">{% trans "Interfaces" %}</dt>
            <dd class="col-md-3">{{ summary.interface_count }}</dd>

            <dt class="col-md-3 text-success">{% trans "Successful" %}</dt>
            <dd class="col-md-3 text-success">{{ summary.success }}</dd>

            <dt class="col-md-3 text-info">{% trans "Dry Run" %}</dt>
            <dd class="col-md-3 text-info">{{ summary.dry_run }}</dd>

            <dt class="col-md-3 text-danger">{% trans "Errors" %}</dt>
            <dd class="col-md-3 text-danger">{{ summary.error }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  {# Device Summary Cards #}
  {% if device_summaries %}
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">{% trans "Device Summary" %}</h5>
        </div>
        <div class="card-body">
          <div class="row">
            {% for device_summary in device_summaries %}
            <div class="col-md-3 mb-2">
              <div class="card device-summary-card" 
                   data-device-name="{{ device_summary.device_name }}"
                   style="cursor: pointer; border-left: 4px solid {% if device_summary.device_status == 'pass' %}#198754{% elif device_summary.device_status == 'warn' %}#ffc107{% else %}#dc3545{% endif %};">
                <div class="card-body p-2">
                  <h6 class="mb-1">
                    <a href="{% url 'dcim:device' pk=device_summary.device.pk %}" onclick="event.stopPropagation();">{{ device_summary.device_name }}</a>
                  </h6>
                  <div class="small">
                    <span class="badge bg-secondary">{{ device_summary.total }} total</span>
                    <span class="badge bg-success">{{ device_summary.pass }} pass</span>
                    {% if device_summary.warn > 0 %}
                    <span class="badge bg-warning text-dark">{{ device_summary.warn }} warn</span>
                    {% endif %}
                    {% if device_summary.blocked > 0 %}
                    <span class="badge bg-danger">{{ device_summary.blocked }} blocked</span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">{% trans "VLAN Deployment Results" %}</h5>
          <div>
            <div class="btn-group btn-group-sm me-2" role="group" id="status-filter-buttons">
              <button type="button" class="btn btn-primary active" data-filter="all">
                All{% if status_counts.total %} ({{ status_counts.total }}){% endif %}
              </button>
              <button type="button" class="btn btn-outline-primary" data-filter="pass">
                Pass Only{% if status_counts.pass %} ({{ status_counts.pass }}){% endif %}
              </button>
              <button type="button" class="btn btn-outline-primary" data-filter="warnings">
                Warnings Only{% if status_counts.warn %} ({{ status_counts.warn }}){% endif %}
              </button>
              <button type="button" class="btn btn-outline-primary" data-filter="blocked">
                Blocked Only{% if status_counts.blocked %} ({{ status_counts.blocked }}){% endif %}
              </button>
            </div>
            <div class="btn-group btn-group-sm me-2" role="group" id="bulk-action-buttons">
              <button type="button" class="btn btn-outline-secondary" id="expand-all-btn" title="Expand all details">
                <i class="mdi mdi-unfold-more-horizontal"></i> Expand All
              </button>
              <button type="button" class="btn btn-outline-secondary" id="collapse-all-btn" title="Collapse all details">
                <i class="mdi mdi-unfold-less-horizontal"></i> Collapse All
              </button>
            </div>
            <button type="button" id="download-csv-btn" class="btn btn-sm btn-secondary">
              <i class="mdi mdi-download"></i>
              {% trans "Download CSV" %}
            </button>
          </div>
        </div>
        <div class="card-body table-responsive">
          {% render_table table %}
        </div>
      </div>
      
      <script>
        // Status filter functionality
        document.addEventListener('DOMContentLoaded', function() {
          const filterButtons = document.querySelectorAll('#status-filter-buttons button');
          const tableRows = document.querySelectorAll('tbody tr');
          let currentDeviceFilter = null; // Track device filter
          
          // Device card filtering
          const deviceCards = document.querySelectorAll('.device-summary-card');
          deviceCards.forEach(card => {
            card.addEventListener('click', function() {
              const deviceName = this.getAttribute('data-device-name');
              
              // Toggle device filter
              if (currentDeviceFilter === deviceName) {
                // Deselect - show all devices
                currentDeviceFilter = null;
                deviceCards.forEach(c => c.style.opacity = '1');
                deviceCards.forEach(c => c.style.borderLeftWidth = '4px');
              } else {
                // Select this device
                currentDeviceFilter = deviceName;
                deviceCards.forEach(c => {
                  if (c.getAttribute('data-device-name') === deviceName) {
                    c.style.opacity = '1';
                    c.style.borderLeftWidth = '6px';
                  } else {
                    c.style.opacity = '0.5';
                    c.style.borderLeftWidth = '4px';
                  }
                });
              }
              
              // Apply filters
              applyFilters();
            });
          });
          
          function applyFilters() {
            let visibleCount = 0;
            tableRows.forEach(row => {
              const details = row.querySelector('details.deployment-logs');
              const statusFilter = details ? details.getAttribute('data-status-filter') : '';
              
              // Get device name from first cell
              const cells = row.querySelectorAll('td');
              const deviceCell = cells[0];
              const deviceLink = deviceCell.querySelector('a');
              const rowDeviceName = deviceLink ? deviceLink.textContent.trim() : '';
              
              // Find Overall Status column
              let statusText = '';
              if (statusFilter) {
                statusText = statusFilter.toLowerCase(); // Normalize to lowercase
              } else {
                if (cells.length > 5) {
                  const statusCell = cells[5];
                  const badge = statusCell.querySelector('.badge');
                  if (badge) {
                    const text = badge.textContent.trim().toLowerCase();
                    // Check for common status values (case-insensitive)
                    if (text.includes('pass') || text === 'pass' || text === 'success') {
                      statusText = 'pass';
                    } else if (text.includes('warn') || text === 'warn' || text === 'warning') {
                      statusText = 'warn';
                    } else if (text.includes('block') || text === 'blocked' || text === 'error' || text === 'fail') {
                      statusText = 'blocked';
                    }
                  }
                }
              }
              
              // Get active status filter
              const activeStatusFilter = document.querySelector('#status-filter-buttons button.active');
              const statusFilterValue = activeStatusFilter ? activeStatusFilter.getAttribute('data-filter') : 'all';
              
              // Apply status filter (case-insensitive comparison)
              let show = false;
              if (statusFilterValue === 'all') {
                show = true;
              } else if (statusFilterValue === 'pass') {
                show = statusText === 'pass' || statusText === 'success';
              } else if (statusFilterValue === 'warnings') {
                show = statusText === 'warn' || statusText === 'warning';
              } else if (statusFilterValue === 'blocked') {
                show = statusText === 'blocked' || statusText === 'block' || statusText === 'error' || statusText === 'fail';
              }
              
              // Apply device filter
              if (show && currentDeviceFilter) {
                show = (rowDeviceName === currentDeviceFilter);
              }
              
              if (show) {
                row.style.display = '';
                visibleCount++;
              } else {
                row.style.display = 'none';
              }
            });
            
            console.log(`Showing ${visibleCount} of ${tableRows.length} rows`);
          }
          
          filterButtons.forEach(button => {
            button.addEventListener('click', function() {
              // Update button states
              filterButtons.forEach(btn => {
                btn.classList.remove('active', 'btn-primary');
                btn.classList.add('btn-outline-primary');
              });
              this.classList.add('active', 'btn-primary');
              this.classList.remove('btn-outline-primary');
              
              // Apply filters
              applyFilters();
            });
          });
          
          // Bulk actions: Expand All
          document.getElementById('expand-all-btn').addEventListener('click', function() {
            tableRows.forEach(row => {
              if (row.style.display !== 'none') {
                const details = row.querySelector('details.deployment-logs');
                if (details) {
                  details.open = true;
                }
              }
            });
          });
          
          // Bulk actions: Collapse All
          document.getElementById('collapse-all-btn').addEventListener('click', function() {
            tableRows.forEach(row => {
              const details = row.querySelector('details.deployment-logs');
              if (details) {
                details.open = false;
              }
            });
          });
        });
        
        // CSV download functionality
        document.getElementById('download-csv-btn').addEventListener('click', function() {
          // Get the table
          const table = document.querySelector('table');
          let csv = [];
          
          // Get headers
          const headers = [];
          table.querySelectorAll('thead th').forEach(th => {
            headers.push(th.textContent.trim());
          });
          csv.push(headers.join(','));
          
          // Get rows (only visible ones)
          table.querySelectorAll('tbody tr').forEach(tr => {
            if (tr.style.display !== 'none') {
              const row = [];
              tr.querySelectorAll('td').forEach(td => {
                // Escape quotes and wrap in quotes if contains comma
                let value = td.textContent.trim().replace(/"/g, '""');
                if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                  value = '"' + value + '"';
                }
                row.push(value);
              });
              csv.push(row.join(','));
            }
          });
          
          // Create download
          const csvContent = csv.join('\n');
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'vlan_deployment_results.csv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        });
      </script>
    </div>
  </div>
  
  {# Back to Form Button #}
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="text-center">
        <a href="{% url 'plugins:netbox_automation_plugin:vlan_deployment' %}" class="btn btn-primary">
          <i class="mdi mdi-arrow-left"></i>
          {% trans "Back to Form" %}
        </a>
      </div>
    </div>
  </div>
{% endblock %}

