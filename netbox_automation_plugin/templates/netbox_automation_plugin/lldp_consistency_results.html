{% extends 'base/layout.html' %}
{% load i18n %}
{% load render_table from django_tables2 %}
{% load form_helpers %}

{% block title %}{% trans "LLDP Consistency Check Results" %}{% endblock %}

{% block content %}
<style>
  /* Dark mode compatibility for LLDP Consistency Results */
  /* FORCE all text: WHITE in dark mode, BLACK in light mode - NO GREY! */
  
  /* Light mode: Black text */
  .card-body,
  .card-body *:not(input):not(select):not(textarea):not(button):not(.form-control):not(.form-select):not(.btn):not(.badge),
  .card-header,
  .card-header *,
  h1, h2, h3, h4, h5, h6,
  .card-title,
  dt,
  dd {
    color: #212529 !important; /* Pure black for light mode */
  }
  
  /* Dark mode: White text */
  @media (prefers-color-scheme: dark) {
    .card-body,
    .card-body *:not(input):not(select):not(textarea):not(button):not(.form-control):not(.form-select):not(.btn):not(.badge),
    .card-header,
    .card-header *,
    h1, h2, h3, h4, h5, h6,
    .card-title,
    dt,
    dd {
      color: #ffffff !important; /* Pure white for dark mode */
    }
  }
  
  /* Help text - NO GREY: Black in light, White in dark */
  .form-text,
  .text-muted,
  small,
  p.text-muted,
  label.text-muted,
  small.text-muted {
    color: #212529 !important; /* Black for light mode */
    opacity: 1 !important;
  }
  
  @media (prefers-color-scheme: dark) {
    .form-text,
    .text-muted,
    small,
    p.text-muted,
    label.text-muted,
    small.text-muted {
      color: #ffffff !important; /* White for dark mode */
      opacity: 1 !important;
    }
  }
  
  .table {
    color: var(--nbx-color-fg-default, #212529) !important;
  }
  
  .table td,
  .table th {
    color: var(--nbx-color-fg-default, #212529) !important;
  }
</style>
  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">{% trans "LLDP Consistency Check Summary" %}</h5>
          <small class="text-muted">Code executed at: {{ code_version }}</small>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-md-3">{% trans "Devices checked" %}</dt>
            <dd class="col-md-3">{{ summary.device_count }}</dd>

            <dt class="col-md-3">{% trans "Interfaces with LLDP" %}</dt>
            <dd class="col-md-3">{{ summary.interface_count }}</dd>

            <dt class="col-md-3 text-success">{% trans "OK" %}</dt>
            <dd class="col-md-3 text-success">{{ summary.ok }}</dd>

            <dt class="col-md-3 text-warning">{% trans "Warnings" %}</dt>
            <dd class="col-md-3 text-warning">{{ summary.warning }}</dd>

            <dt class="col-md-3 text-danger">{% trans "Errors" %}</dt>
            <dd class="col-md-3 text-danger">{{ summary.error }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">{% trans "LLDP Consistency Results" %}</h5>
          <button type="button" id="download-csv-btn" class="btn btn-sm btn-secondary">
            <i class="mdi mdi-download"></i>
            {% trans "Download CSV" %}
          </button>
        </div>
        <div class="card-body table-responsive">
          {% render_table table %}
        </div>
      </div>
      
      <!-- Hidden form for CSV export (uses cached results from session) -->
      <form method="post" id="csv-export-form" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="export_csv" value="1">
      </form>

      <script>
        // NetBox Theme Detection and Color Application
        function getNetBoxTheme() {
          try {
            return localStorage.getItem('netbox-color-mode') || 'light';
          } catch (e) {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
          }
        }
        
        function isDarkMode() {
          return getNetBoxTheme() === 'dark';
        }
        
        function applyThemeColors() {
          const darkMode = isDarkMode();
          const textColor = darkMode ? '#ffffff' : '#212529';
          
          // Apply to all text elements in card-body
          document.querySelectorAll('.card-body p, .card-body label, .card-body span, .card-body small, .card-body div, .card-body .form-text, .card-body .text-muted, .card-body h1, .card-body h2, .card-body h3, .card-body h4, .card-body h5, .card-body h6, .card-body dt, .card-body dd').forEach(el => {
            el.style.setProperty('color', textColor, 'important');
            if (el.classList.contains('text-muted') || el.classList.contains('form-text')) {
              el.style.setProperty('opacity', '1', 'important');
            }
          });
          
          // Apply to card header
          document.querySelectorAll('.card-header, .card-header *').forEach(el => {
            el.style.setProperty('color', textColor, 'important');
          });
          
          // Apply to form text elements globally
          document.querySelectorAll('.form-text, .text-muted, small').forEach(el => {
            el.style.setProperty('color', textColor, 'important');
            el.style.setProperty('opacity', '1', 'important');
          });
        }
        
        // Apply on page load
        document.addEventListener('DOMContentLoaded', function() {
          applyThemeColors();
          
          // Listen for NetBox theme changes
          window.addEventListener('netbox.colorModeChanged', function(e) {
            setTimeout(applyThemeColors, 100);
          });
          
          // Also check periodically in case theme changes
          setInterval(applyThemeColors, 2000);
        });
        
      <script>
        document.getElementById('download-csv-btn').addEventListener('click', function() {
          // Submit the hidden form to trigger server-side CSV export from cached results
          document.getElementById('csv-export-form').submit();
        });
      </script>
    </div>
  </div>
{% endblock %}


