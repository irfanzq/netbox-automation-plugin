{% extends 'base/layout.html' %}
{% load i18n %}
{% load form_helpers %}

{% block title %}{% trans "NetBox VLAN Tagging" %}{% endblock %}

{% block content %}
  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">{% trans "NetBox VLAN Tagging Workflow" %}</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">
            {% trans "Analyze devices and interfaces based on defined criteria and apply NetBox tags. This is a standalone analysis and tagging tool." %}
          </p>

          {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
              {{ form.non_field_errors }}
            </div>
          {% endif %}

          <form method="post" id="vlan-tagging-form">
            {% csrf_token %}

            {# Workflow Mode #}
            <div class="mb-3">
              <label class="form-label">{{ form.workflow_mode.label }}</label>
              <div class="form-text">{{ form.workflow_mode.help_text }}</div>
              {% for radio in form.workflow_mode %}
                <div class="form-check">
                  {{ radio.tag }}
                  <label class="form-check-label" for="{{ radio.id_for_label }}">
                    {{ radio.choice_label }}
                  </label>
                </div>
              {% endfor %}
              {% if form.workflow_mode.errors %}
                <div class="invalid-feedback d-block">{{ form.workflow_mode.errors }}</div>
              {% endif %}
            </div>

            {# Device Selection #}
            <div class="mb-3">
              <label class="form-label">{{ form.device_selection.label }}</label>
              <div class="form-text">{{ form.device_selection.help_text }}</div>
              {% for radio in form.device_selection %}
                <div class="form-check">
                  {{ radio.tag }}
                  <label class="form-check-label" for="{{ radio.id_for_label }}">
                    {{ radio.choice_label }}
                  </label>
                </div>
              {% endfor %}
              {% if form.device_selection.errors %}
                <div class="invalid-feedback d-block">{{ form.device_selection.errors }}</div>
              {% endif %}
            </div>

            {# Single Device Mode Fields #}
            <div id="single-device-fields" style="display: none;">
              <div class="mb-3">
                <label for="{{ form.devices.id_for_label }}" class="form-label">{{ form.devices.label }}</label>
                {{ form.devices }}
                <div class="form-text">{{ form.devices.help_text }}</div>
                {% if form.devices.errors %}
                  <div class="invalid-feedback d-block">{{ form.devices.errors }}</div>
                {% endif %}
              </div>
            </div>

            {# Device Group Mode Fields #}
            <div id="group-device-fields" style="display: none;">
              <div class="mb-3">
                <label for="{{ form.site.id_for_label }}" class="form-label">{{ form.site.label }}</label>
                {{ form.site }}
                <div class="form-text">{{ form.site.help_text }}</div>
                {% if form.site.errors %}
                  <div class="invalid-feedback d-block">{{ form.site.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="{{ form.location.id_for_label }}" class="form-label">{{ form.location.label }}</label>
                {{ form.location }}
                <div class="form-text">{{ form.location.help_text }}</div>
                {% if form.location.errors %}
                  <div class="invalid-feedback d-block">{{ form.location.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="{{ form.manufacturer.id_for_label }}" class="form-label">{{ form.manufacturer.label }}</label>
                {{ form.manufacturer }}
                <div class="form-text">{{ form.manufacturer.help_text }}</div>
                {% if form.manufacturer.errors %}
                  <div class="invalid-feedback d-block">{{ form.manufacturer.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="{{ form.role.id_for_label }}" class="form-label">{{ form.role.label }}</label>
                {{ form.role }}
                <div class="form-text">{{ form.role.help_text }}</div>
                {% if form.role.errors %}
                  <div class="invalid-feedback d-block">{{ form.role.errors }}</div>
                {% endif %}
              </div>
            </div>

            {# Tagging Mode Options (only shown in tagging mode) #}
            <div id="tagging-options" style="display: none;">
              <div class="mb-3">
                <div class="form-check">
                  {{ form.tag_devices }}
                  <label class="form-check-label" for="{{ form.tag_devices.id_for_label }}">
                    {{ form.tag_devices.label }}
                  </label>
                </div>
                <div class="form-text">{{ form.tag_devices.help_text }}</div>
                {% if form.tag_devices.errors %}
                  <div class="invalid-feedback d-block">{{ form.tag_devices.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <div class="form-check">
                  {{ form.tag_interfaces }}
                  <label class="form-check-label" for="{{ form.tag_interfaces.id_for_label }}">
                    {{ form.tag_interfaces.label }}
                  </label>
                </div>
                <div class="form-text">{{ form.tag_interfaces.help_text }}</div>
                {% if form.tag_interfaces.errors %}
                  <div class="invalid-feedback d-block">{{ form.tag_interfaces.errors }}</div>
                {% endif %}
              </div>

              <hr class="my-3">

              <h6 class="text-danger">{% trans "Delete Tags" %}</h6>
              <div class="alert alert-warning mb-3" style="font-size: 0.9em;">
                <strong>{% trans "Warning:" %}</strong> {% trans "Deleting tags will affect VLAN deployment workflow. Devices without 'automation-ready:vlan' tag will be blocked from VLAN deployment." %}
              </div>

              <div class="mb-3">
                <div class="form-check">
                  {{ form.delete_device_tags }}
                  <label class="form-check-label" for="{{ form.delete_device_tags.id_for_label }}">
                    {{ form.delete_device_tags.label }}
                  </label>
                </div>
                <div class="form-text">{{ form.delete_device_tags.help_text }}</div>
                {% if form.delete_device_tags.errors %}
                  <div class="invalid-feedback d-block">{{ form.delete_device_tags.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <div class="form-check">
                  {{ form.delete_interface_tags }}
                  <label class="form-check-label" for="{{ form.delete_interface_tags.id_for_label }}">
                    {{ form.delete_interface_tags.label }}
                  </label>
                </div>
                <div class="form-text">{{ form.delete_interface_tags.help_text }}</div>
                {% if form.delete_interface_tags.errors %}
                  <div class="invalid-feedback d-block">{{ form.delete_interface_tags.errors }}</div>
                {% endif %}
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" id="submit-btn" class="btn btn-primary" name="action" value="analyze">
                <i class="mdi mdi-play" id="submit-icon"></i>
                <span id="submit-text">{% trans "Run Analysis" %}</span>
              </button>
              <button type="submit" id="deploy-btn" class="btn btn-success" name="action" value="deploy" style="display: none;">
                <i class="mdi mdi-tag-multiple" id="deploy-icon"></i>
                <span id="deploy-text">{% trans "Deploy Tags" %}</span>
              </button>
              <button type="submit" id="delete-btn" class="btn btn-danger" name="action" value="delete" style="display: none;">
                <i class="mdi mdi-delete" id="delete-icon"></i>
                <span id="delete-text">{% trans "Delete Tags" %}</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Style for disabled checkboxes and buttons */
    input[type="checkbox"]:disabled + label {
      opacity: 0.5;
      cursor: not-allowed;
    }
    input[type="checkbox"]:disabled {
      cursor: not-allowed;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>

  <script>
    function toggleDeviceSelectionFields() {
      const deviceSelection = document.querySelector('input[name="device_selection"]:checked');
      const singleFields = document.getElementById('single-device-fields');
      const groupFields = document.getElementById('group-device-fields');
      
      if (!deviceSelection || !singleFields || !groupFields) {
        return;
      }
      
      if (deviceSelection.value === 'single') {
        singleFields.style.display = 'block';
        groupFields.style.display = 'none';
      } else {
        singleFields.style.display = 'none';
        groupFields.style.display = 'block';
      }
    }

    function toggleTaggingOptions() {
      const workflowMode = document.querySelector('input[name="workflow_mode"]:checked');
      const taggingOptions = document.getElementById('tagging-options');
      const submitBtn = document.getElementById('submit-btn');
      const deployBtn = document.getElementById('deploy-btn');
      const deleteBtn = document.getElementById('delete-btn');
      
      if (!workflowMode || !taggingOptions) {
        return;
      }
      
      if (workflowMode.value === 'tagging') {
        taggingOptions.style.display = 'block';
        // Show deploy and delete buttons, hide analyze button
        if (submitBtn) submitBtn.style.display = 'none';
        if (deployBtn) deployBtn.style.display = 'inline-block';
        if (deleteBtn) deleteBtn.style.display = 'inline-block';
        // Update mutual exclusivity
        updateMutualExclusivity();
      } else {
        taggingOptions.style.display = 'none';
        // Show analyze button, hide deploy and delete buttons
        if (submitBtn) submitBtn.style.display = 'inline-block';
        if (deployBtn) deployBtn.style.display = 'none';
        if (deleteBtn) deleteBtn.style.display = 'none';
      }
    }

    function updateMutualExclusivity() {
      const tagDevices = document.getElementById('id_tag_devices');
      const tagInterfaces = document.getElementById('id_tag_interfaces');
      const deleteDeviceTags = document.getElementById('id_delete_device_tags');
      const deleteInterfaceTags = document.getElementById('id_delete_interface_tags');
      const deployBtn = document.getElementById('deploy-btn');
      const deleteBtn = document.getElementById('delete-btn');
      
      if (!tagDevices || !tagInterfaces || !deleteDeviceTags || !deleteInterfaceTags) {
        return;
      }
      
      const hasTagging = tagDevices.checked || tagInterfaces.checked;
      const hasDeletion = deleteDeviceTags.checked || deleteInterfaceTags.checked;
      
      // If tagging is selected, disable deletion options and delete button
      if (hasTagging) {
        deleteDeviceTags.disabled = true;
        deleteInterfaceTags.disabled = true;
        if (deleteBtn) deleteBtn.disabled = true;
        if (deployBtn) deployBtn.disabled = false;
      }
      // If deletion is selected, disable tagging options and deploy button
      else if (hasDeletion) {
        tagDevices.disabled = true;
        tagInterfaces.disabled = true;
        if (deployBtn) deployBtn.disabled = true;
        if (deleteBtn) deleteBtn.disabled = false;
      }
      // If nothing is selected, enable all options and buttons
      else {
        tagDevices.disabled = false;
        tagInterfaces.disabled = false;
        deleteDeviceTags.disabled = false;
        deleteInterfaceTags.disabled = false;
        if (deployBtn) deployBtn.disabled = false;
        if (deleteBtn) deleteBtn.disabled = false;
      }
    }

    // Initialize functions
    function initFormToggles() {
      // Toggle device selection fields
      document.querySelectorAll('input[name="device_selection"]').forEach(radio => {
        radio.addEventListener('change', toggleDeviceSelectionFields);
      });

      // Toggle tagging options based on workflow mode
      document.querySelectorAll('input[name="workflow_mode"]').forEach(radio => {
        radio.addEventListener('change', toggleTaggingOptions);
      });

      // Add listeners for mutual exclusivity
      const tagDevices = document.getElementById('id_tag_devices');
      const tagInterfaces = document.getElementById('id_tag_interfaces');
      const deleteDeviceTags = document.getElementById('id_delete_device_tags');
      const deleteInterfaceTags = document.getElementById('id_delete_interface_tags');
      
      if (tagDevices) tagDevices.addEventListener('change', updateMutualExclusivity);
      if (tagInterfaces) tagInterfaces.addEventListener('change', updateMutualExclusivity);
      if (deleteDeviceTags) deleteDeviceTags.addEventListener('change', updateMutualExclusivity);
      if (deleteInterfaceTags) deleteInterfaceTags.addEventListener('change', updateMutualExclusivity);

      // Set initial state
      toggleDeviceSelectionFields();
      toggleTaggingOptions();
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFormToggles);
    } else {
      // DOM is already ready
      initFormToggles();
    }
  </script>
{% endblock %}

