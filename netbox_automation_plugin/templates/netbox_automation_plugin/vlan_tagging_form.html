{% extends 'base/layout.html' %}
{% load i18n %}
{% load form_helpers %}

{% block title %}{% trans "NetBox VLAN Tagging" %}{% endblock %}

{% block content %}
<style>
  /* Dark mode compatibility for VLAN Tagging Form */
  /* Use NetBox CSS variables with explicit fallbacks - NO GREY! */
  
  /* Use NetBox CSS variables - they adapt to theme automatically */
  .card-body,
  .card-body *:not(input):not(select):not(textarea):not(button):not(.form-control):not(.form-select):not(.btn):not(.badge) {
    color: var(--nbx-color-fg-default) !important;
  }
  
  /* Force visibility - ensure text is never grey */
  .card-body .text-muted,
  .card-body .form-text,
  .card-body small {
    color: var(--nbx-color-fg-default) !important;
    opacity: 1 !important;
  }
  
  /* Specific overrides for common text elements */
  .card-body .form-label,
  .card-body label:not(.form-check-label),
  .card-body .form-check-label,
  .card-body p,
  .card-body div.form-text,
  .card-body span,
  .card-body small,
  .card-body h1,
  .card-body h2,
  .card-body h3,
  .card-body h4,
  .card-body h5,
  .card-body h6,
  .card-body .card-title {
    color: var(--nbx-color-fg-default, #212529) !important;
  }
  
  /* Dark mode overrides */
  html[data-theme="dark"] .card-body .form-label,
  html[data-theme="dark"] .card-body label:not(.form-check-label),
  html[data-theme="dark"] .card-body .form-check-label,
  html[data-theme="dark"] .card-body p,
  html[data-theme="dark"] .card-body div.form-text,
  html[data-theme="dark"] .card-body span,
  html[data-theme="dark"] .card-body small,
  html[data-theme="dark"] .card-body h1,
  html[data-theme="dark"] .card-body h2,
  html[data-theme="dark"] .card-body h3,
  html[data-theme="dark"] .card-body h4,
  html[data-theme="dark"] .card-body h5,
  html[data-theme="dark"] .card-body h6,
  html[data-theme="dark"] .card-body .card-title,
  body.dark-mode .card-body .form-label,
  body.dark-mode .card-body label:not(.form-check-label),
  body.dark-mode .card-body .form-check-label,
  body.dark-mode .card-body p,
  body.dark-mode .card-body div.form-text,
  body.dark-mode .card-body span,
  body.dark-mode .card-body small,
  body.dark-mode .card-body h1,
  body.dark-mode .card-body h2,
  body.dark-mode .card-body h3,
  body.dark-mode .card-body h4,
  body.dark-mode .card-body h5,
  body.dark-mode .card-body h6,
  body.dark-mode .card-body .card-title {
    color: #ffffff !important; /* White for dark mode */
  }
  
  /* Help text and muted text - NO GREY: Black in light, White in dark */
  .card-body .form-text,
  .card-body .text-muted,
  .card-body p.text-muted,
  .card-body label.text-muted,
  .card-body small.text-muted,
  .form-text,
  .text-muted,
  p.text-muted,
  label.text-muted,
  small.text-muted,
  small {
    color: #212529 !important; /* Black for light mode */
    opacity: 1 !important;
  }
  
  html[data-theme="dark"] .card-body .form-text,
  html[data-theme="dark"] .card-body .text-muted,
  html[data-theme="dark"] .card-body p.text-muted,
  html[data-theme="dark"] .card-body label.text-muted,
  html[data-theme="dark"] .card-body small.text-muted,
  html[data-theme="dark"] .form-text,
  html[data-theme="dark"] .text-muted,
  html[data-theme="dark"] p.text-muted,
  html[data-theme="dark"] label.text-muted,
  html[data-theme="dark"] small.text-muted,
  html[data-theme="dark"] small,
  body.dark-mode .card-body .form-text,
  body.dark-mode .card-body .text-muted,
  body.dark-mode .card-body p.text-muted,
  body.dark-mode .card-body label.text-muted,
  body.dark-mode .card-body small.text-muted,
  body.dark-mode .form-text,
  body.dark-mode .text-muted,
  body.dark-mode p.text-muted,
  body.dark-mode label.text-muted,
  body.dark-mode small.text-muted,
  body.dark-mode small {
    color: #ffffff !important; /* White for dark mode */
    opacity: 1 !important;
  }
  
  /* Card header text */
  .card-header,
  .card-header * {
    color: #212529 !important; /* Black for light mode */
  }
  
  html[data-theme="dark"] .card-header,
  html[data-theme="dark"] .card-header *,
  body.dark-mode .card-header,
  body.dark-mode .card-header * {
    color: #ffffff !important; /* White for dark mode */
  }
  
  html[data-theme="dark"] .form-control,
  html[data-theme="dark"] .form-select,
  html[data-theme="dark"] select.form-control,
  html[data-theme="dark"] select.form-select,
  html[data-theme="dark"] textarea.form-control,
  html[data-theme="dark"] input[type="text"],
  html[data-theme="dark"] input[type="number"],
  html[data-theme="dark"] input[type="email"],
  html[data-theme="dark"] input[type="password"],
  html[data-theme="dark"] input[type="search"],
  html[data-theme="dark"] input.form-control,
  html[data-theme="dark"] textarea,
  body.dark-mode .form-control,
  body.dark-mode .form-select,
  body.dark-mode select.form-control,
  body.dark-mode select.form-select,
  body.dark-mode textarea.form-control,
  body.dark-mode input[type="text"],
  body.dark-mode input[type="number"],
  body.dark-mode input[type="email"],
  body.dark-mode input[type="password"],
  body.dark-mode input[type="search"],
  body.dark-mode input.form-control,
  body.dark-mode textarea {
    background-color: #ffffff !important; /* White background in dark mode */
    color: #212529 !important; /* Black text in dark mode - force for readability */
    border-color: var(--nbx-color-border-input, #ced4da) !important;
  }
  
  .form-control,
  .form-select,
  select.form-control,
  select.form-select,
  textarea.form-control {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    color: var(--nbx-color-fg-default, #212529) !important;
    border-color: var(--nbx-color-border-input, #ced4da) !important;
  }
  
  html[data-theme="dark"] .form-control::placeholder,
  body.dark-mode .form-control::placeholder {
    color: var(--nbx-color-fg-default) !important;
    opacity: 0.7;
  }
  
  .form-control::placeholder {
    color: var(--nbx-color-fg-default, #212529) !important;
    opacity: 0.7;
  }
  
  html[data-theme="dark"] .form-control:focus,
  html[data-theme="dark"] .form-select:focus,
  html[data-theme="dark"] select.form-control:focus,
  html[data-theme="dark"] select.form-select:focus,
  html[data-theme="dark"] textarea.form-control:focus,
  html[data-theme="dark"] input[type="text"]:focus,
  html[data-theme="dark"] input[type="number"]:focus,
  html[data-theme="dark"] input.form-control:focus,
  html[data-theme="dark"] textarea:focus,
  body.dark-mode .form-control:focus,
  body.dark-mode .form-select:focus,
  body.dark-mode select.form-control:focus,
  body.dark-mode select.form-select:focus,
  body.dark-mode textarea.form-control:focus,
  body.dark-mode input[type="text"]:focus,
  body.dark-mode input[type="number"]:focus,
  body.dark-mode input.form-control:focus,
  body.dark-mode textarea:focus {
    background-color: #ffffff !important; /* White background in dark mode */
    color: #212529 !important; /* Black text in dark mode - force for readability */
    border-color: var(--nbx-color-border-input-focus, #86b7fe) !important;
  }
  
  .form-control:focus,
  .form-select:focus,
  select.form-control:focus,
  select.form-select:focus,
  textarea.form-control:focus {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    color: var(--nbx-color-fg-default, #212529) !important;
    border-color: var(--nbx-color-border-input-focus, #86b7fe) !important;
  }
  
  /* Checkbox and radio button styling */
  html[data-theme="dark"] .form-check-input,
  body.dark-mode .form-check-input {
    background-color: var(--nbx-color-bg-input) !important;
  }
  
  .form-check-input {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    border-color: var(--nbx-color-border-input, #ced4da) !important;
  }
  
  .form-check-input:checked {
    background-color: var(--nbx-color-primary, #0d6efd) !important;
    border-color: var(--nbx-color-primary, #0d6efd) !important;
  }
  
  .form-check-input:focus {
    border-color: var(--nbx-color-border-input-focus, #86b7fe) !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }
  
  .form-check-label {
    color: var(--nbx-color-fg-default, #212529) !important;
  }
  
  /* Datalist dropdown styling */
  html[data-theme="dark"] datalist option,
  body.dark-mode datalist option {
    background-color: var(--nbx-color-bg-input) !important;
    color: var(--nbx-color-fg-default) !important;
  }
  
  datalist option {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    color: var(--nbx-color-fg-default, #212529) !important;
  }
  
  /* Select dropdown options */
  html[data-theme="dark"] select option,
  body.dark-mode select option {
    background-color: var(--nbx-color-bg-input) !important;
    color: var(--nbx-color-fg-default) !important;
  }
  
  select option {
    background-color: var(--nbx-color-bg-input, #fff) !important;
    color: var(--nbx-color-fg-default, #212529) !important;
  }
  
  .invalid-feedback {
    color: var(--nbx-color-danger, #dc3545) !important;
  }
  
  .alert-danger {
    background-color: var(--nbx-color-bg-danger-subtle) !important;
    color: var(--nbx-color-fg-danger) !important;
    border-color: var(--nbx-color-border-danger) !important;
  }
  
  /* Override for dark mode if NetBox variables don't provide good contrast */
  html[data-theme="dark"] .alert-danger,
  body.dark-mode .alert-danger {
    background-color: #5a1a1a !important; /* Dark red background for better visibility */
    color: #ffffff !important; /* Light white text for better visibility */
    border-color: #dc3545 !important;
  }
</style>
  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">{% trans "NetBox VLAN Tagging Workflow" %}</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">
            {% trans "Analyze devices and interfaces based on defined criteria and apply NetBox tags. This is a standalone analysis and tagging tool." %}
          </p>

          {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
              {{ form.non_field_errors }}
            </div>
          {% endif %}

          <form method="post" id="vlan-tagging-form">
            {% csrf_token %}

            {# Workflow Mode #}
            <div class="mb-3">
              <label class="form-label">{{ form.workflow_mode.label }}</label>
              <div class="form-text">{{ form.workflow_mode.help_text }}</div>
              {% for radio in form.workflow_mode %}
                <div class="form-check">
                  {{ radio.tag }}
                  <label class="form-check-label" for="{{ radio.id_for_label }}">
                    {{ radio.choice_label }}
                  </label>
                </div>
              {% endfor %}
              {% if form.workflow_mode.errors %}
                <div class="invalid-feedback d-block">{{ form.workflow_mode.errors }}</div>
              {% endif %}
            </div>

            {# Device Selection #}
            <div class="mb-3">
              <label class="form-label">{{ form.device_selection.label }}</label>
              <div class="form-text">{{ form.device_selection.help_text }}</div>
              {% for radio in form.device_selection %}
                <div class="form-check">
                  {{ radio.tag }}
                  <label class="form-check-label" for="{{ radio.id_for_label }}">
                    {{ radio.choice_label }}
                  </label>
                </div>
              {% endfor %}
              {% if form.device_selection.errors %}
                <div class="invalid-feedback d-block">{{ form.device_selection.errors }}</div>
              {% endif %}
            </div>

            {# Single Device Mode Fields #}
            <div id="single-device-fields" style="display: none;">
              <div class="mb-3">
                <label for="{{ form.devices.id_for_label }}" class="form-label">{{ form.devices.label }}</label>
                {{ form.devices }}
                <div class="form-text">{{ form.devices.help_text }}</div>
                {% if form.devices.errors %}
                  <div class="invalid-feedback d-block">{{ form.devices.errors }}</div>
                {% endif %}
              </div>
            </div>

            {# Device Group Mode Fields #}
            <div id="group-device-fields" style="display: none;">
              <div class="mb-3">
                <label for="{{ form.site.id_for_label }}" class="form-label">{{ form.site.label }}</label>
                {{ form.site }}
                <div class="form-text">{{ form.site.help_text }}</div>
                {% if form.site.errors %}
                  <div class="invalid-feedback d-block">{{ form.site.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="{{ form.location.id_for_label }}" class="form-label">{{ form.location.label }}</label>
                {{ form.location }}
                <div class="form-text">{{ form.location.help_text }}</div>
                {% if form.location.errors %}
                  <div class="invalid-feedback d-block">{{ form.location.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="{{ form.manufacturer.id_for_label }}" class="form-label">{{ form.manufacturer.label }}</label>
                {{ form.manufacturer }}
                <div class="form-text">{{ form.manufacturer.help_text }}</div>
                {% if form.manufacturer.errors %}
                  <div class="invalid-feedback d-block">{{ form.manufacturer.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="{{ form.role.id_for_label }}" class="form-label">{{ form.role.label }}</label>
                {{ form.role }}
                <div class="form-text">{{ form.role.help_text }}</div>
                {% if form.role.errors %}
                  <div class="invalid-feedback d-block">{{ form.role.errors }}</div>
                {% endif %}
              </div>
            </div>

            {# Tagging Mode Options (only shown in tagging mode) #}
            <div id="tagging-options" style="display: none;">
              <div class="mb-3">
                <div class="form-check">
                  {{ form.tag_devices }}
                  <label class="form-check-label" for="{{ form.tag_devices.id_for_label }}">
                    {{ form.tag_devices.label }}
                  </label>
                </div>
                <div class="form-text">{{ form.tag_devices.help_text }}</div>
                {% if form.tag_devices.errors %}
                  <div class="invalid-feedback d-block">{{ form.tag_devices.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <div class="form-check">
                  {{ form.tag_interfaces }}
                  <label class="form-check-label" for="{{ form.tag_interfaces.id_for_label }}">
                    {{ form.tag_interfaces.label }}
                  </label>
                </div>
                <div class="form-text">{{ form.tag_interfaces.help_text }}</div>
                {% if form.tag_interfaces.errors %}
                  <div class="invalid-feedback d-block">{{ form.tag_interfaces.errors }}</div>
                {% endif %}
              </div>

              <hr class="my-3">

              <h6 class="text-danger">{% trans "Delete Tags" %}</h6>
              <div class="alert alert-warning mb-3" style="font-size: 0.9em;">
                <strong>{% trans "Warning:" %}</strong> {% trans "Deleting tags will affect VLAN deployment workflow. Devices without 'automation-ready:vlan' tag will be blocked from VLAN deployment." %}
              </div>

              <div class="mb-3">
                <div class="form-check">
                  {{ form.delete_device_tags }}
                  <label class="form-check-label" for="{{ form.delete_device_tags.id_for_label }}">
                    {{ form.delete_device_tags.label }}
                  </label>
                </div>
                <div class="form-text">{{ form.delete_device_tags.help_text }}</div>
                {% if form.delete_device_tags.errors %}
                  <div class="invalid-feedback d-block">{{ form.delete_device_tags.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <div class="form-check">
                  {{ form.delete_interface_tags }}
                  <label class="form-check-label" for="{{ form.delete_interface_tags.id_for_label }}">
                    {{ form.delete_interface_tags.label }}
                  </label>
                </div>
                <div class="form-text">{{ form.delete_interface_tags.help_text }}</div>
                {% if form.delete_interface_tags.errors %}
                  <div class="invalid-feedback d-block">{{ form.delete_interface_tags.errors }}</div>
                {% endif %}
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" id="submit-btn" class="btn btn-primary" name="action" value="analyze">
                <i class="mdi mdi-play" id="submit-icon"></i>
                <span id="submit-text">{% trans "Run Analysis" %}</span>
              </button>
              <button type="submit" id="deploy-btn" class="btn btn-success" name="action" value="deploy" style="display: none;">
                <i class="mdi mdi-tag-multiple" id="deploy-icon"></i>
                <span id="deploy-text">{% trans "Deploy Tags" %}</span>
              </button>
              <button type="submit" id="delete-btn" class="btn btn-danger" name="action" value="delete" style="display: none;">
                <i class="mdi mdi-delete" id="delete-icon"></i>
                <span id="delete-text">{% trans "Delete Tags" %}</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  {# Loading Modal #}
  <div id="loading-modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false" style="display: none; z-index: 9999;">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-body text-center py-5">
          <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem; border-width: 0.3rem;">
            <span class="sr-only">Loading...</span>
          </div>
          <h5 id="loading-message" class="mb-2">{% trans "Processing..." %}</h5>
          <p class="text-muted mb-0">{% trans "Please wait while we process your request." %}</p>
        </div>
      </div>
    </div>
  </div>
  <div id="loading-backdrop" class="modal-backdrop fade" style="display: none; z-index: 9998;"></div>

  <style>
    /* Style for disabled checkboxes and buttons */
    input[type="checkbox"]:disabled + label {
      opacity: 0.5;
      cursor: not-allowed;
    }
    input[type="checkbox"]:disabled {
      cursor: not-allowed;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* Loading modal styles */
    #loading-modal .modal-content {
      border: none;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    #loading-modal .spinner-border {
      border-width: 0.3rem;
    }
    
    /* Rotating animation for spinner */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .spinner-border {
      animation: spin 0.75s linear infinite;
    }
  </style>

  <script>
    // NetBox Theme Detection and Color Application
    function getNetBoxTheme() {
      try {
        return localStorage.getItem('netbox-color-mode') || 'light';
      } catch (e) {
        // Fallback: check if NetBox has set data-theme attribute
        const htmlEl = document.documentElement;
        if (htmlEl && htmlEl.getAttribute('data-theme') === 'dark') {
          return 'dark';
        }
        if (document.body && document.body.classList.contains('dark-mode')) {
          return 'dark';
        }
        return 'light';
      }
    }
    
    function isDarkMode() {
      return getNetBoxTheme() === 'dark';
    }
    
    function applyThemeColors() {
      const darkMode = isDarkMode();
      const textColor = darkMode ? '#ffffff' : '#212529';
      const bgColor = darkMode ? '#2a2a2a' : '#f8f9fa';
      
      // Apply to ALL text elements in card-body (more comprehensive)
      const cardBody = document.querySelector('.card-body');
      if (cardBody) {
        const allTextElements = cardBody.querySelectorAll('p, label, span, small, div, h1, h2, h3, h4, h5, h6, dt, dd, li, td, th, .form-text, .text-muted, .form-label, .form-check-label');
        allTextElements.forEach(el => {
          // Skip form controls
          if (!el.closest('input') && !el.closest('select') && !el.closest('textarea') && !el.closest('button') && !el.classList.contains('form-control') && !el.classList.contains('form-select') && !el.classList.contains('btn')) {
            el.style.setProperty('color', textColor, 'important');
            if (el.classList.contains('text-muted') || el.classList.contains('form-text')) {
              el.style.setProperty('opacity', '1', 'important');
            }
          }
        });
      }
      
      // Apply to card header
      document.querySelectorAll('.card-header, .card-header *').forEach(el => {
        if (!el.closest('input') && !el.closest('select') && !el.closest('textarea') && !el.closest('button')) {
          el.style.setProperty('color', textColor, 'important');
        }
      });
      
      // Apply to form text elements globally
      document.querySelectorAll('.form-text, .text-muted, small, .form-label, .form-check-label').forEach(el => {
        if (!el.closest('input') && !el.closest('select') && !el.closest('textarea') && !el.closest('button')) {
          el.style.setProperty('color', textColor, 'important');
          el.style.setProperty('opacity', '1', 'important');
        }
      });
    }
    
    // Apply on page load
    document.addEventListener('DOMContentLoaded', function() {
      applyThemeColors();
      
      // Listen for NetBox theme changes
      window.addEventListener('netbox.colorModeChanged', function(e) {
        setTimeout(applyThemeColors, 100);
      });
      
      // Also check periodically in case theme changes
      setInterval(applyThemeColors, 2000);
    });
    
    // Run immediately (in case DOM is already loaded)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', applyThemeColors);
    } else {
      applyThemeColors();
    }
    
    // Use MutationObserver to catch dynamically added elements
    const observer = new MutationObserver(function(mutations) {
      applyThemeColors();
    });
    
    // Start observing when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        observer.observe(document.body, { childList: true, subtree: true });
      });
    } else {
      observer.observe(document.body, { childList: true, subtree: true });
    }
    
    // Make function available globally for dynamic elements
    window.getNetBoxTextColor = function() {
      return isDarkMode() ? '#ffffff' : '#212529';
    };
    
    function toggleDeviceSelectionFields() {
      const deviceSelection = document.querySelector('input[name="device_selection"]:checked');
      const singleFields = document.getElementById('single-device-fields');
      const groupFields = document.getElementById('group-device-fields');
      
      if (!deviceSelection || !singleFields || !groupFields) {
        return;
      }
      
      if (deviceSelection.value === 'single') {
        singleFields.style.display = 'block';
        groupFields.style.display = 'none';
      } else {
        singleFields.style.display = 'none';
        groupFields.style.display = 'block';
      }
    }

    function toggleTaggingOptions() {
      const workflowMode = document.querySelector('input[name="workflow_mode"]:checked');
      const taggingOptions = document.getElementById('tagging-options');
      const submitBtn = document.getElementById('submit-btn');
      const deployBtn = document.getElementById('deploy-btn');
      const deleteBtn = document.getElementById('delete-btn');
      
      if (!workflowMode || !taggingOptions) {
        return;
      }
      
      if (workflowMode.value === 'tagging') {
        taggingOptions.style.display = 'block';
        // Show deploy and delete buttons, hide analyze button
        if (submitBtn) submitBtn.style.display = 'none';
        if (deployBtn) deployBtn.style.display = 'inline-block';
        if (deleteBtn) deleteBtn.style.display = 'inline-block';
        // Update mutual exclusivity
        updateMutualExclusivity();
      } else {
        taggingOptions.style.display = 'none';
        // Show analyze button, hide deploy and delete buttons
        if (submitBtn) submitBtn.style.display = 'inline-block';
        if (deployBtn) deployBtn.style.display = 'none';
        if (deleteBtn) deleteBtn.style.display = 'none';
      }
    }

    function updateMutualExclusivity() {
      const tagDevices = document.getElementById('id_tag_devices');
      const tagInterfaces = document.getElementById('id_tag_interfaces');
      const deleteDeviceTags = document.getElementById('id_delete_device_tags');
      const deleteInterfaceTags = document.getElementById('id_delete_interface_tags');
      const deployBtn = document.getElementById('deploy-btn');
      const deleteBtn = document.getElementById('delete-btn');
      
      if (!tagDevices || !tagInterfaces || !deleteDeviceTags || !deleteInterfaceTags) {
        return;
      }
      
      const hasTagging = tagDevices.checked || tagInterfaces.checked;
      const hasDeletion = deleteDeviceTags.checked || deleteInterfaceTags.checked;
      
      // If tagging is selected, disable deletion options and delete button
      if (hasTagging) {
        deleteDeviceTags.disabled = true;
        deleteInterfaceTags.disabled = true;
        if (deleteBtn) deleteBtn.disabled = true;
        if (deployBtn) deployBtn.disabled = false;
      }
      // If deletion is selected, disable tagging options and deploy button
      else if (hasDeletion) {
        tagDevices.disabled = true;
        tagInterfaces.disabled = true;
        if (deployBtn) deployBtn.disabled = true;
        if (deleteBtn) deleteBtn.disabled = false;
      }
      // If nothing is selected, enable all options and buttons
      else {
        tagDevices.disabled = false;
        tagInterfaces.disabled = false;
        deleteDeviceTags.disabled = false;
        deleteInterfaceTags.disabled = false;
        if (deployBtn) deployBtn.disabled = false;
        if (deleteBtn) deleteBtn.disabled = false;
      }
    }

    // Initialize functions
    function initFormToggles() {
      // Toggle device selection fields
      document.querySelectorAll('input[name="device_selection"]').forEach(radio => {
        radio.addEventListener('change', toggleDeviceSelectionFields);
      });

      // Toggle tagging options based on workflow mode
      document.querySelectorAll('input[name="workflow_mode"]').forEach(radio => {
        radio.addEventListener('change', toggleTaggingOptions);
      });

      // Add listeners for mutual exclusivity
      const tagDevices = document.getElementById('id_tag_devices');
      const tagInterfaces = document.getElementById('id_tag_interfaces');
      const deleteDeviceTags = document.getElementById('id_delete_device_tags');
      const deleteInterfaceTags = document.getElementById('id_delete_interface_tags');
      
      if (tagDevices) tagDevices.addEventListener('change', updateMutualExclusivity);
      if (tagInterfaces) tagInterfaces.addEventListener('change', updateMutualExclusivity);
      if (deleteDeviceTags) deleteDeviceTags.addEventListener('change', updateMutualExclusivity);
      if (deleteInterfaceTags) deleteInterfaceTags.addEventListener('change', updateMutualExclusivity);

      // Set initial state
      toggleDeviceSelectionFields();
      toggleTaggingOptions();
    }

    // Show loading modal on form submission
    function showLoadingModal(action) {
      const modal = document.getElementById('loading-modal');
      const backdrop = document.getElementById('loading-backdrop');
      const message = document.getElementById('loading-message');
      
      // Set appropriate message based on action
      let actionMessage = '';
      switch(action) {
        case 'analyze':
          actionMessage = '{% trans "Running Analysis..." %}';
          break;
        case 'deploy':
          actionMessage = '{% trans "Applying Tags to NetBox..." %}';
          break;
        case 'delete':
          actionMessage = '{% trans "Deleting Tags from NetBox..." %}';
          break;
        default:
          actionMessage = '{% trans "Processing..." %}';
      }
      
      if (message) {
        message.textContent = actionMessage;
      }
      
      // Show modal - works with both Bootstrap 4 and 5
      if (modal) {
        // Show backdrop
        if (backdrop) {
          backdrop.style.display = 'block';
          backdrop.classList.add('show');
        }
        
        // Show modal
        modal.style.display = 'block';
        modal.classList.add('show');
        document.body.classList.add('modal-open');
        document.body.style.overflow = 'hidden';
      }
    }

    // Hide loading modal (in case page doesn't redirect)
    function hideLoadingModal() {
      const modal = document.getElementById('loading-modal');
      const backdrop = document.getElementById('loading-backdrop');
      
      if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
      }
      
      if (backdrop) {
        backdrop.style.display = 'none';
        backdrop.classList.remove('show');
      }
      
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
    }

    // Add form submission handler
    function initFormSubmission() {
      const form = document.getElementById('vlan-tagging-form');
      if (!form) return;
      
      form.addEventListener('submit', function(e) {
        // Get the action button that was clicked
        const submitEvent = e.submitter || (window.event ? window.event.submitter : null);
        let action = 'analyze'; // default
        
        if (submitEvent) {
          action = submitEvent.value || submitEvent.name || 'analyze';
        } else {
          // Fallback: check which button is visible/enabled
          const deployBtn = document.getElementById('deploy-btn');
          const deleteBtn = document.getElementById('delete-btn');
          const submitBtn = document.getElementById('submit-btn');
          
          if (deployBtn && deployBtn.style.display !== 'none' && !deployBtn.disabled) {
            action = 'deploy';
          } else if (deleteBtn && deleteBtn.style.display !== 'none' && !deleteBtn.disabled) {
            action = 'delete';
          } else if (submitBtn && submitBtn.style.display !== 'none' && !submitBtn.disabled) {
            action = 'analyze';
          }
        }
        
        // Show loading modal
        showLoadingModal(action);
        
        // Disable all buttons to prevent double submission
        const buttons = form.querySelectorAll('button[type="submit"]');
        buttons.forEach(btn => {
          btn.disabled = true;
        });
      });
    }

    // Initialize functions
    function initFormToggles() {
      // Toggle device selection fields
      document.querySelectorAll('input[name="device_selection"]').forEach(radio => {
        radio.addEventListener('change', toggleDeviceSelectionFields);
      });

      // Toggle tagging options based on workflow mode
      document.querySelectorAll('input[name="workflow_mode"]').forEach(radio => {
        radio.addEventListener('change', toggleTaggingOptions);
      });

      // Add listeners for mutual exclusivity
      const tagDevices = document.getElementById('id_tag_devices');
      const tagInterfaces = document.getElementById('id_tag_interfaces');
      const deleteDeviceTags = document.getElementById('id_delete_device_tags');
      const deleteInterfaceTags = document.getElementById('id_delete_interface_tags');
      
      if (tagDevices) tagDevices.addEventListener('change', updateMutualExclusivity);
      if (tagInterfaces) tagInterfaces.addEventListener('change', updateMutualExclusivity);
      if (deleteDeviceTags) deleteDeviceTags.addEventListener('change', updateMutualExclusivity);
      if (deleteInterfaceTags) deleteInterfaceTags.addEventListener('change', updateMutualExclusivity);

      // Set initial state
      toggleDeviceSelectionFields();
      toggleTaggingOptions();
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        initFormToggles();
        initFormSubmission();
      });
    } else {
      // DOM is already ready
      initFormToggles();
      initFormSubmission();
    }
  </script>
{% endblock %}

